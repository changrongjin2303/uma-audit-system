# 🎓 造价审计系统 - 新手部署图解教程

> 零基础也能看懂的部署教程,每一步都有详细说明

---

## 📖 教程导航

1. [购买阿里云服务器](#第一步-购买阿里云服务器)
2. [连接到服务器](#第二步-连接到服务器)
3. [上传项目代码](#第三步-上传项目代码)
4. [一键部署](#第四步-一键部署)
5. [访问系统](#第五步-访问系统)
6. [日常维护](#第六步-日常维护)

---

## 第一步: 购买阿里云服务器

### 1.1 进入阿里云官网

🔗 访问: https://www.aliyun.com/

点击 **"产品" → "云服务器ECS"**

### 1.2 选择配置

**推荐配置** (适合生产使用):
```
┌─────────────────────────────┐
│  CPU: 4核                   │
│  内存: 8GB                  │
│  硬盘: 100GB SSD            │
│  带宽: 5Mbps                │
│  系统: Ubuntu 22.04 64位    │
│  地域: 就近选择(如华东1)    │
└─────────────────────────────┘
```

**最低配置** (适合测试):
```
┌─────────────────────────────┐
│  CPU: 2核                   │
│  内存: 4GB                  │
│  硬盘: 40GB SSD             │
│  带宽: 3Mbps                │
│  系统: Ubuntu 22.04 64位    │
└─────────────────────────────┘
```

### 1.3 重要配置项

✅ **一定要勾选的选项**:
- ☑ 分配公网IP地址
- ☑ 安全组选择 "放通常用端口"

✅ **设置登录密码**:
- 用户名: `root` (默认)
- 密码: 设置一个强密码并**记录下来**
  ```
  建议格式: 大写+小写+数字+符号,至少12位
  例如: MyPass@2025!Secure
  ```

### 1.4 记录服务器信息

购买完成后,记录以下信息:

```
┌────────────────────────────────────┐
│ 服务器信息记录卡                   │
├────────────────────────────────────┤
│ 公网IP: ________________           │
│                                    │
│ root密码: ________________         │
│                                    │
│ 地域: ________________             │
│                                    │
│ 购买时间: ________________         │
└────────────────────────────────────┘
```

💡 **提示**: 这些信息非常重要,请妥善保管!

---

## 第二步: 连接到服务器

### 2.1 Windows用户 - 使用Xshell

#### 安装Xshell

1. 下载地址: https://www.xshell.com/zh/free-for-home-school/
2. 下载免费版 (家庭/学校版)
3. 安装,一路点击"下一步"

#### 连接服务器

**步骤图解**:

```
1. 打开Xshell → 点击"文件" → "新建"

   ┌──────────────────────────┐
   │  [新建会话属性]          │
   ├──────────────────────────┤
   │  名称: 造价审计系统      │
   │  协议: SSH               │
   │  主机: [你的服务器IP]    │
   │  端口: 22                │
   └──────────────────────────┘

2. 点击左侧"用户身份验证"

   ┌──────────────────────────┐
   │  方法: Password          │
   │  用户名: root            │
   │  密码: [你的root密码]    │
   └──────────────────────────┘

3. 点击"连接"
```

**首次连接提示**:
```
┌────────────────────────────────┐
│  SSH安全警告                   │
│  主机密钥未知,是否接受?        │
│                                │
│  [接受并保存]  [拒绝]          │
└────────────────────────────────┘
```
点击 **"接受并保存"**

**连接成功标志**:
```bash
Welcome to Ubuntu 22.04 LTS
Last login: Mon Jan 20 10:30:00 2025

root@iZ2ze1234567Z:~#  ← 出现这个提示符就成功了!
```

### 2.2 Mac用户 - 使用终端

#### 打开终端

1. 按 `Command + 空格`
2. 输入 "终端" 或 "Terminal"
3. 按回车打开

#### 连接服务器

**在终端输入**:
```bash
ssh root@你的服务器IP地址
```

**示例**:
```bash
ssh root@47.98.123.45
```

**首次连接提示**:
```
The authenticity of host '47.98.123.45' can't be established.
Are you sure you want to continue connecting (yes/no)?
```
输入 `yes` 并按回车

**输入密码**:
```
root@47.98.123.45's password:
```
输入你的root密码 (输入时不显示,直接输入后按回车)

**连接成功**:
```bash
Welcome to Ubuntu 22.04 LTS
root@iZ2ze1234567Z:~#
```

---

## 第三步: 上传项目代码

### 3.1 Windows用户 - 使用WinSCP

#### 安装WinSCP

1. 下载地址: https://winscp.net/eng/download.php
2. 下载安装包并安装

#### 上传文件

**步骤图解**:

```
1. 打开WinSCP,填写连接信息:

   ┌──────────────────────────┐
   │ 文件协议: SFTP           │
   │ 主机名: [服务器IP]       │
   │ 端口号: 22               │
   │ 用户名: root             │
   │ 密码: [root密码]         │
   └──────────────────────────┘

2. 点击"登录"

3. 界面说明:
   ┌─────────────┬─────────────┐
   │  本地电脑   │   服务器    │
   │  (左侧)     │   (右侧)    │
   ├─────────────┼─────────────┤
   │ C:\Users\   │ /root/      │
   │ Documents\  │             │
   │ uma-audit5\ │             │
   └─────────────┴─────────────┘

4. 在右侧(服务器)进入 /opt 目录:
   - 双击根目录 /
   - 双击 opt 文件夹

5. 在左侧(本地)找到你的项目文件夹:
   - 找到 uma-audit5 文件夹

6. 拖拽上传:
   - 将左侧的 uma-audit5 文件夹
   - 拖到右侧的 /opt 目录下
```

**上传进度**:
```
┌────────────────────────────────┐
│ 正在上传...                    │
│ ████████████░░░░░░ 65%         │
│ uma-audit5/backend/main.py     │
│ 预计剩余时间: 2分钟            │
└────────────────────────────────┘
```

上传完成后,在右侧应该看到:
```
/opt/
  └── uma-audit5/
      ├── backend/
      ├── frontend/
      ├── docker-compose.yml
      └── ...
```

### 3.2 Mac用户 - 使用终端上传

#### 使用scp命令

**在你的Mac终端执行** (不是服务器终端):

```bash
# 进入项目所在目录
cd ~/Documents/code/

# 上传整个项目
scp -r uma-audit5 root@你的服务器IP:/opt/
```

**示例**:
```bash
scp -r uma-audit5 root@47.98.123.45:/opt/
```

**上传进度显示**:
```
main.py                  100%   12KB   1.2MB/s   00:00
config.py               100%    5KB   890KB/s   00:00
...
```

### 3.3 验证上传成功

**在SSH终端执行**:
```bash
cd /opt/uma-audit5
ls -la
```

**应该看到**:
```
total 128
drwxr-xr-x  8 root root  4096 Jan 20 10:30 .
drwxr-xr-x  3 root root  4096 Jan 20 10:25 ..
drwxr-xr-x  5 root root  4096 Jan 20 10:30 backend
drwxr-xr-x  6 root root  4096 Jan 20 10:30 frontend
-rw-r--r--  1 root root  3421 Jan 20 10:30 docker-compose.yml
-rwxr-xr-x  1 root root  8934 Jan 20 10:30 deploy-to-aliyun.sh
...
```

✅ 看到项目文件就说明上传成功了!

---

## 第四步: 一键部署

### 4.1 运行部署脚本

**在SSH终端执行**:

```bash
cd /opt/uma-audit5
./deploy-to-aliyun.sh
```

### 4.2 部署过程图解

脚本会自动执行以下步骤:

```
┌─────────────────────────────────────┐
│ 步骤 1/8: 检查系统环境...          │
│ ✓ Docker 已安装                    │
│ ✓ Docker Compose 已安装            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 2/8: 配置生产环境...          │
│ 正在生成安全密钥...                │
│ 数据库密码: xK9m2P...              │
│ Redis密码: aB7n4Q...               │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 请输入服务器公网IP地址:            │
│ > 47.98.123.45                      │ ← 输入你的IP
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 3/8: 创建Docker配置...        │
│ ✓ 已创建 docker-compose.prod.yml  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 4/8: 创建前端配置...          │
│ ✓ 已创建前端生产Dockerfile         │
│ ✓ 已创建Nginx配置文件              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 5/8: 构建Docker镜像...        │
│ 这可能需要5-10分钟,请耐心等待...   │
│                                     │
│ Building backend                    │
│ ████████░░░░░░░░ 45%               │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 6/8: 启动所有服务...          │
│ Creating uma_audit_db_prod          │
│ Creating uma_audit_redis_prod       │
│ Creating uma_audit_backend_prod     │
│ Creating uma_audit_frontend_prod    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 7/8: 初始化数据库...          │
│ 运行数据库迁移...                  │
│ ✓ 数据库初始化完成                 │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 步骤 8/8: 创建管理员账号...        │
│ 是否创建管理员账号? (y/n):         │
│ > y                                 │ ← 输入y
│                                     │
│ 管理员用户名:                      │
│ > admin                             │ ← 输入用户名
│                                     │
│ 管理员密码:                        │
│ > ********                          │ ← 输入密码
└─────────────────────────────────────┘
```

### 4.3 部署成功提示

```
======================================
  部署完成! 🎉
======================================

访问信息:
----------------------------------------
前端地址: http://47.98.123.45
后端API文档: http://47.98.123.45:8000/docs

安全信息 (请妥善保管):
----------------------------------------
数据库密码: xK9m2P7nQwE5rT8uY...
Redis密码: aB7n4QmL9xZ2cV...

常用命令:
----------------------------------------
查看日志: docker-compose -f docker-compose.prod.yml logs -f
重启服务: docker-compose -f docker-compose.prod.yml restart
停止服务: docker-compose -f docker-compose.prod.yml stop

下一步:
----------------------------------------
1. 在浏览器访问 http://47.98.123.45
2. 检查系统是否正常运行
3. 配置域名和HTTPS (可选)
4. 设置定期备份
```

💡 **重要**: 将显示的密码复制并保存到安全的地方!

---

## 第五步: 访问系统

### 5.1 检查服务状态

**在SSH终端执行**:
```bash
docker-compose -f docker-compose.prod.yml ps
```

**正常状态应显示**:
```
NAME                        STATUS
uma_audit_backend_prod      Up 2 minutes
uma_audit_db_prod           Up 2 minutes (healthy)
uma_audit_frontend_prod     Up 2 minutes
uma_audit_redis_prod        Up 2 minutes (healthy)
```

✅ 所有服务都是 `Up` 状态就OK了!

### 5.2 浏览器访问

#### 访问前端页面

在浏览器地址栏输入:
```
http://你的服务器IP
```

**示例**:
```
http://47.98.123.45
```

**应该看到登录页面**:
```
┌─────────────────────────────────┐
│                                 │
│    造价材料审计系统              │
│                                 │
│    用户名: [____________]       │
│                                 │
│    密码:   [____________]       │
│                                 │
│           [  登  录  ]          │
│                                 │
└─────────────────────────────────┘
```

#### 访问API文档

在浏览器地址栏输入:
```
http://你的服务器IP:8000/docs
```

**应该看到Swagger API文档**:
```
┌─────────────────────────────────┐
│  FastAPI - Swagger UI           │
├─────────────────────────────────┤
│  认证接口                       │
│    POST /api/v1/auth/register   │
│    POST /api/v1/auth/login      │
│                                 │
│  项目管理接口                   │
│    GET  /api/v1/projects/       │
│    POST /api/v1/projects/       │
│    ...                          │
└─────────────────────────────────┘
```

### 5.3 登录测试

使用部署时创建的管理员账号登录:

```
用户名: admin
密码: [你设置的密码]
```

**登录成功后应该看到**:
```
┌─────────────────────────────────┐
│  [菜单]  造价材料审计系统       │
├─────────────────────────────────┤
│                                 │
│  欢迎,admin!                    │
│                                 │
│  ┌─────┐  ┌─────┐  ┌─────┐    │
│  │项目 │  │材料 │  │分析 │    │
│  │管理 │  │管理 │  │报告 │    │
│  └─────┘  └─────┘  └─────┘    │
│                                 │
└─────────────────────────────────┘
```

✅ 能看到这个页面,恭喜你部署成功! 🎉

---

## 第六步: 日常维护

### 6.1 每天要做的事

#### 检查系统健康

**在SSH终端执行**:
```bash
cd /opt/uma-audit5
./health-check.sh
```

**健康检查报告**:
```
======================================
  系统健康检查
======================================

检查 1/8: Docker服务
----------------------------------------
✓ Docker服务运行正常

检查 2/8: 容器运行状态
----------------------------------------
✓ uma_audit_db_prod: 运行中
✓ uma_audit_redis_prod: 运行中
✓ uma_audit_backend_prod: 运行中
✓ uma_audit_frontend_prod: 运行中

...

======================================
  健康检查总结
======================================

通过: 15
警告: 0
失败: 0

✓ 系统运行正常!
```

### 6.2 数据备份

#### 手动备份

**在SSH终端执行**:
```bash
cd /opt/uma-audit5
./backup-data.sh
```

**备份过程**:
```
======================================
  数据备份工具
======================================

步骤 1/3: 备份PostgreSQL数据库...
----------------------------------------
✓ 数据库备份完成 (大小: 15MB)

步骤 2/3: 备份上传文件...
----------------------------------------
✓ 上传文件备份完成 (大小: 256MB)

步骤 3/3: 备份配置文件...
----------------------------------------
✓ 配置文件备份完成 (大小: 2.1KB)

======================================
  备份完成! ✓
======================================
```

#### 设置自动备份

**执行一次,以后每天自动备份**:

```bash
crontab -e
```

**首次运行会提示选择编辑器**:
```
Select an editor:
  1. /bin/nano
  2. /usr/bin/vim.basic
  3. /usr/bin/vim.tiny

Choose 1-3 [1]:
```
选择 `1` (nano编辑器,最简单)

**在打开的编辑器中添加**:
```bash
# 每天凌晨2点自动备份
0 2 * * * /opt/uma-audit5/backup-data.sh
```

**保存并退出**:
- 按 `Ctrl + X`
- 按 `Y` 确认保存
- 按 `Enter` 确认文件名

✅ 现在系统会每天自动备份了!

### 6.3 查看日志

#### 查看所有日志

```bash
cd /opt/uma-audit5
docker-compose -f docker-compose.prod.yml logs
```

#### 实时查看日志

```bash
docker-compose -f docker-compose.prod.yml logs -f
```

按 `Ctrl + C` 停止查看

#### 只看错误日志

```bash
docker-compose -f docker-compose.prod.yml logs | grep -i error
```

#### 只看某个服务的日志

```bash
# 查看后端日志
docker-compose -f docker-compose.prod.yml logs backend

# 查看数据库日志
docker-compose -f docker-compose.prod.yml logs postgres
```

### 6.4 重启服务

#### 重启所有服务

```bash
cd /opt/uma-audit5
docker-compose -f docker-compose.prod.yml restart
```

#### 重启单个服务

```bash
# 重启后端
docker-compose -f docker-compose.prod.yml restart backend

# 重启前端
docker-compose -f docker-compose.prod.yml restart frontend
```

### 6.5 更新系统

**当有新版本时**:

```bash
cd /opt/uma-audit5

# 备份数据
./backup-data.sh

# 拉取新代码 (如果使用Git)
git pull

# 或者用WinSCP/FileZilla上传新文件覆盖

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up -d --build

# 运行数据库迁移
docker exec -it uma_audit_backend_prod python -m alembic upgrade head
```

---

## 🆘 遇到问题怎么办?

### 问题诊断流程图

```
遇到问题
   ↓
检查服务状态
   ├─ 所有服务都在运行? ──→ 是 ──→ 检查日志
   └─ 有服务停止? ──→ 是 ──→ 重启服务
                              ↓
                         查看启动日志
                              ↓
                    根据错误信息排查
```

### 常见问题速查

#### ❌ 问题1: 网站打不开

**检查步骤**:
```bash
# 1. 检查容器是否运行
docker ps

# 2. 如果有容器没运行,重启
docker-compose -f docker-compose.prod.yml up -d

# 3. 检查端口
netstat -tuln | grep 80

# 4. 检查阿里云安全组是否开放80端口
```

#### ❌ 问题2: 登录失败

**解决方法**:
```bash
# 重置管理员密码
docker exec -it uma_audit_backend_prod bash
# 然后在容器内执行重置密码脚本
```

#### ❌ 问题3: 上传文件失败

**检查步骤**:
```bash
# 1. 检查磁盘空间
df -h

# 2. 如果空间不足,清理
docker system prune -a
```

#### ❌ 问题4: 系统很慢

**优化步骤**:
```bash
# 1. 查看资源使用
docker stats

# 2. 查看内存
free -h

# 3. 如果内存不足,重启服务
docker-compose -f docker-compose.prod.yml restart
```

---

## 📚 进阶学习

### 推荐阅读顺序

1. ✅ **新手部署图解教程.md** (当前文档)
   - 适合: 第一次部署
   - 目的: 快速上手

2. 📖 **阿里云部署指南.md**
   - 适合: 需要详细了解每个步骤
   - 目的: 深入理解部署过程

3. 📋 **部署快速参考.md**
   - 适合: 日常维护使用
   - 目的: 快速查找命令

4. 📖 **README-部署.md**
   - 适合: 全面了解部署资源
   - 目的: 掌握所有工具和脚本

### 视频教程 (如果有)

- [ ] 购买和配置阿里云服务器
- [ ] 使用SSH连接服务器
- [ ] 上传代码和一键部署
- [ ] 日常维护和故障排查

---

## ✅ 部署检查清单

完成部署后,请逐项打勾:

```
前期准备:
  ☐ 购买阿里云服务器
  ☐ 配置安全组开放端口
  ☐ 记录服务器IP和密码
  ☐ 安装SSH客户端 (Xshell/终端)

部署过程:
  ☐ 成功连接到服务器
  ☐ 上传项目代码到 /opt/uma-audit5
  ☐ 运行一键部署脚本
  ☐ 所有Docker容器正常运行
  ☐ 数据库初始化完成
  ☐ 创建管理员账号

功能测试:
  ☐ 能访问前端页面
  ☐ 能访问API文档
  ☐ 能成功登录系统
  ☐ 能创建项目
  ☐ 能上传材料文件

安全配置:
  ☐ 记录数据库密码
  ☐ 记录Redis密码
  ☐ 记录管理员密码
  ☐ 防火墙配置正确

日常维护:
  ☐ 设置自动备份
  ☐ 测试健康检查
  ☐ 了解常用命令
  ☐ 知道如何查看日志
```

全部打勾就说明部署完美! 🎉

---

## 🎯 下一步计划

### 立即要做

- [x] 完成系统部署
- [ ] 创建测试项目
- [ ] 上传测试材料数据
- [ ] 测试AI价格分析功能
- [ ] 生成测试报告

### 一周内完成

- [ ] 配置域名 (可选)
- [ ] 配置HTTPS证书
- [ ] 邀请用户试用
- [ ] 收集反馈优化

### 一月内完成

- [ ] 培训用户使用
- [ ] 积累真实数据
- [ ] 优化系统性能
- [ ] 建立运维流程

---

## 🎓 结语

恭喜你完成了造价审计系统的部署!

如果在部署过程中遇到任何问题:
1. 先查看本文档的常见问题部分
2. 查看详细日志分析错误
3. 参考完整的部署指南文档
4. 记录问题现象和日志,寻求技术支持

**记住**:
- 📝 定期备份数据
- 👀 定期检查系统健康
- 🔐 保管好所有密码
- 📖 遇到问题多查文档

祝你使用愉快! 🎉

---

**文档版本**: v1.0
**更新时间**: 2025年1月20日
**适用系统**: Ubuntu 22.04 + Docker
**难度等级**: ⭐ 新手友好
