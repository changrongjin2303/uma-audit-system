# é€ ä»·å®¡è®¡ç³»ç»Ÿ - é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æŒ‡å—

> ğŸ“ æœ¬æŒ‡å—ä¸“ä¸ºéæŠ€æœ¯äººå‘˜ç¼–å†™ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†è¯´æ˜

---

## ğŸ“š ç›®å½•

1. [è´­ä¹°å’Œå‡†å¤‡é˜¿é‡Œäº‘æœåŠ¡å™¨](#ç¬¬ä¸€æ­¥è´­ä¹°å’Œå‡†å¤‡é˜¿é‡Œäº‘æœåŠ¡å™¨)
2. [è¿æ¥åˆ°æœåŠ¡å™¨](#ç¬¬äºŒæ­¥è¿æ¥åˆ°æœåŠ¡å™¨)
3. [å®‰è£…å¿…è¦è½¯ä»¶](#ç¬¬ä¸‰æ­¥å®‰è£…å¿…è¦è½¯ä»¶)
4. [ä¸Šä¼ é¡¹ç›®ä»£ç ](#ç¬¬å››æ­¥ä¸Šä¼ é¡¹ç›®ä»£ç )
5. [é…ç½®ç”Ÿäº§ç¯å¢ƒ](#ç¬¬äº”æ­¥é…ç½®ç”Ÿäº§ç¯å¢ƒ)
6. [å¯åŠ¨åº”ç”¨](#ç¬¬å…­æ­¥å¯åŠ¨åº”ç”¨)
7. [é…ç½®åŸŸåå’ŒHTTPS](#ç¬¬ä¸ƒæ­¥é…ç½®åŸŸåå’Œhttpså¯é€‰ä½†æ¨è)
8. [æ—¥å¸¸ç»´æŠ¤](#ç¬¬å…«æ­¥æ—¥å¸¸ç»´æŠ¤)

---

## ç¬¬ä¸€æ­¥ï¼šè´­ä¹°å’Œå‡†å¤‡é˜¿é‡Œäº‘æœåŠ¡å™¨

### 1.1 æœåŠ¡å™¨é…ç½®æ¨è

è®¿é—® [é˜¿é‡Œäº‘å®˜ç½‘](https://www.aliyun.com/) è´­ä¹°ECSäº‘æœåŠ¡å™¨:

**æœ€ä½é…ç½®** (é€‚åˆæµ‹è¯•/å°è§„æ¨¡ä½¿ç”¨):
- CPU: 2æ ¸
- å†…å­˜: 4GB
- ç¡¬ç›˜: 40GB (SSD)
- å¸¦å®½: 3Mbps
- æ“ä½œç³»ç»Ÿ: **Ubuntu 22.04 64ä½** (é‡è¦ï¼)
- é¢„ç®—: çº¦100-200å…ƒ/æœˆ

**æ¨èé…ç½®** (é€‚åˆç”Ÿäº§ç¯å¢ƒ):
- CPU: 4æ ¸
- å†…å­˜: 8GB
- ç¡¬ç›˜: 100GB (SSD)
- å¸¦å®½: 5Mbps
- æ“ä½œç³»ç»Ÿ: **Ubuntu 22.04 64ä½**
- é¢„ç®—: çº¦300-500å…ƒ/æœˆ

### 1.2 è´­ä¹°æ—¶æ³¨æ„äº‹é¡¹

âœ… **å¿…é¡»å‹¾é€‰çš„é¡¹ç›®**:
- åˆ†é…å…¬ç½‘IPåœ°å€
- è®¾ç½®å®‰å…¨ç»„ (é€‰æ‹©"æ”¾é€šå¸¸ç”¨ç«¯å£")
- è®°ä½ä½ è®¾ç½®çš„**rootå¯†ç ** (éå¸¸é‡è¦!)

âœ… **è´­ä¹°å®Œæˆåè®°å½•ä»¥ä¸‹ä¿¡æ¯**:
```
å…¬ç½‘IPåœ°å€: ___________________  (ä¾‹å¦‚: 47.98.123.45)
rootå¯†ç : _____________________  (ä½ è®¾ç½®çš„å¯†ç )
åœ°åŸŸ: _________________________  (ä¾‹å¦‚: åä¸œ1-æ­å·)
```

### 1.3 é…ç½®å®‰å…¨ç»„è§„åˆ™

ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å° â†’ äº‘æœåŠ¡å™¨ECS â†’ ç½‘ç»œä¸å®‰å…¨ â†’ å®‰å…¨ç»„ â†’ é…ç½®è§„åˆ™

**éœ€è¦å¼€æ”¾çš„ç«¯å£**:
| ç«¯å£å· | è¯´æ˜ | å¿…é¡»å¼€æ”¾ |
|--------|------|----------|
| 22 | SSHè¿œç¨‹ç™»å½• | âœ… æ˜¯ |
| 80 | HTTPç½‘ç«™è®¿é—® | âœ… æ˜¯ |
| 443 | HTTPSå®‰å…¨è®¿é—® | âœ… æ˜¯ |
| 8000 | åç«¯APIç«¯å£ | âœ… æ˜¯ |
| 3000 | å‰ç«¯ç«¯å£(ä¸´æ—¶) | âš ï¸ å¯é€‰ |

**æ·»åŠ è§„åˆ™ç¤ºä¾‹**:
```
è§„åˆ™æ–¹å‘: å…¥æ–¹å‘
æˆæƒç­–ç•¥: å…è®¸
åè®®ç±»å‹: TCP
ç«¯å£èŒƒå›´: 80/80
æˆæƒå¯¹è±¡: 0.0.0.0/0
æè¿°: HTTPè®¿é—®
```

å¯¹22ã€443ã€8000ç­‰ç«¯å£é‡å¤ä»¥ä¸Šæ“ä½œã€‚

---

## ç¬¬äºŒæ­¥:è¿æ¥åˆ°æœåŠ¡å™¨

### 2.1 Windowsç”¨æˆ· - ä½¿ç”¨Xshellæˆ–PuTTY

**æ¨èä½¿ç”¨Xshell** (å…è´¹,ä¸­æ–‡ç•Œé¢):

1. ä¸‹è½½å¹¶å®‰è£… [Xshell](https://www.xshell.com/zh/free-for-home-school/)
2. æ‰“å¼€Xshell,ç‚¹å‡»"æ–°å»º"
3. å¡«å†™è¿æ¥ä¿¡æ¯:
   - åç§°: `é˜¿é‡Œäº‘å®¡è®¡ç³»ç»Ÿ`
   - åè®®: `SSH`
   - ä¸»æœº: `ä½ çš„å…¬ç½‘IPåœ°å€`
   - ç«¯å£å·: `22`
4. ç‚¹å‡»"ç”¨æˆ·èº«ä»½éªŒè¯":
   - æ–¹æ³•: `Password`
   - ç”¨æˆ·å: `root`
   - å¯†ç : `ä½ è®¾ç½®çš„rootå¯†ç `
5. ç‚¹å‡»"è¿æ¥"

**é¦–æ¬¡è¿æ¥ä¼šæç¤º**: "SSHå®‰å…¨è­¦å‘Š" â†’ ç‚¹å‡»"æ¥å—å¹¶ä¿å­˜"

è¿æ¥æˆåŠŸå,ä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œç•Œé¢:
```
Welcome to Ubuntu 22.04 LTS
root@iZxxxxxxxxxZ:~#
```

### 2.2 Macç”¨æˆ· - ä½¿ç”¨ç»ˆç«¯

1. æ‰“å¼€"ç»ˆç«¯"åº”ç”¨ (åº”ç”¨ç¨‹åº â†’ å®ç”¨å·¥å…· â†’ ç»ˆç«¯)
2. è¾“å…¥ä»¥ä¸‹å‘½ä»¤ (æ›¿æ¢æˆä½ çš„IPåœ°å€):
   ```bash
   ssh root@ä½ çš„å…¬ç½‘IPåœ°å€
   ```
3. è¾“å…¥å¯†ç  (è¾“å…¥æ—¶ä¸æ˜¾ç¤º,ç›´æ¥è¾“å…¥åæŒ‰å›è½¦)

---

## ç¬¬ä¸‰æ­¥:å®‰è£…å¿…è¦è½¯ä»¶

è¿æ¥åˆ°æœåŠ¡å™¨å,**é€è¡Œå¤åˆ¶ç²˜è´´**ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œã€‚

### 3.1 æ›´æ–°ç³»ç»Ÿ

```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
apt update

# å‡çº§å·²å®‰è£…çš„è½¯ä»¶
apt upgrade -y
```

ç­‰å¾…å®Œæˆ (å¯èƒ½éœ€è¦5-10åˆ†é’Ÿ)

### 3.2 å®‰è£…Dockerå’ŒDocker Compose

Dockerå¯ä»¥è®©ä½ ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡,éå¸¸æ–¹ä¾¿!

```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com | bash

# å¯åŠ¨DockeræœåŠ¡
systemctl start docker
systemctl enable docker

# å®‰è£…Docker Compose
apt install docker-compose -y

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

çœ‹åˆ°ç‰ˆæœ¬å·å°±è¡¨ç¤ºå®‰è£…æˆåŠŸ! ä¾‹å¦‚:
```
Docker version 24.0.5
docker-compose version 1.29.2
```

### 3.3 å®‰è£…å…¶ä»–å·¥å…·

```bash
# å®‰è£…Git (ç”¨äºä»£ç ç®¡ç†)
apt install git -y

# å®‰è£…unzip (ç”¨äºè§£å‹æ–‡ä»¶)
apt install unzip -y

# å®‰è£…vimç¼–è¾‘å™¨
apt install vim -y
```

---

## ç¬¬å››æ­¥:ä¸Šä¼ é¡¹ç›®ä»£ç 

æœ‰ä¸¤ç§æ–¹å¼ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨,é€‰æ‹©ä½ å–œæ¬¢çš„:

### æ–¹å¼ä¸€:ä½¿ç”¨Git (æ¨è)

å¦‚æœä½ çš„ä»£ç åœ¨GitHub/Giteeä¸Š:

```bash
# è¿›å…¥å·¥ä½œç›®å½•
cd /opt

# å…‹éš†é¡¹ç›® (æ›¿æ¢æˆä½ çš„ä»“åº“åœ°å€)
git clone https://github.com/ä½ çš„ç”¨æˆ·å/uma-audit5.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd uma-audit5
```

### æ–¹å¼äºŒ:ä½¿ç”¨FTPä¸Šä¼  (æ›´ç›´è§‚)

**Windowsç”¨æˆ· - ä½¿ç”¨WinSCP**:

1. ä¸‹è½½å®‰è£… [WinSCP](https://winscp.net/eng/download.php)
2. æ‰“å¼€WinSCP,æ–°å»ºç«™ç‚¹:
   - æ–‡ä»¶åè®®: `SFTP`
   - ä¸»æœºå: `ä½ çš„å…¬ç½‘IP`
   - ç«¯å£å·: `22`
   - ç”¨æˆ·å: `root`
   - å¯†ç : `ä½ çš„rootå¯†ç `
3. ç‚¹å‡»"ç™»å½•"
4. å·¦ä¾§æ˜¯ä½ çš„ç”µè„‘,å³ä¾§æ˜¯æœåŠ¡å™¨
5. åœ¨å³ä¾§è¿›å…¥ `/opt` ç›®å½•
6. å°†ä½ æœ¬åœ°çš„ `uma-audit5` æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°å³ä¾§

**Macç”¨æˆ· - ä½¿ç”¨FileZilla**:

1. ä¸‹è½½å®‰è£… [FileZilla](https://filezilla-project.org/)
2. ä¸»æœº: `sftp://ä½ çš„å…¬ç½‘IP`
3. ç”¨æˆ·å: `root`
4. å¯†ç : `ä½ çš„rootå¯†ç `
5. ç«¯å£: `22`
6. ä¸Šä¼ æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹åˆ° `/opt`

ä¸Šä¼ å®Œæˆå,åœ¨SSHç»ˆç«¯æ‰§è¡Œ:
```bash
cd /opt/uma-audit5
ls -la
```

èƒ½çœ‹åˆ°é¡¹ç›®æ–‡ä»¶å°±è¡¨ç¤ºä¸Šä¼ æˆåŠŸ!

---

## ç¬¬äº”æ­¥:é…ç½®ç”Ÿäº§ç¯å¢ƒ

### 5.1 åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶

```bash
# ç¡®ä¿åœ¨é¡¹ç›®ç›®å½•
cd /opt/uma-audit5

# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env .env.production
```

### 5.2 ä¿®æ”¹é…ç½®æ–‡ä»¶

ä½¿ç”¨vimç¼–è¾‘å™¨ (å¦‚æœä¸ç†Ÿæ‚‰,å¯ä»¥ç”¨ä¸‹é¢çš„"å¿«é€Ÿé…ç½®æ–¹å¼"):

```bash
vim .env.production
```

**vimåŸºæœ¬æ“ä½œ**:
- æŒ‰ `i` è¿›å…¥ç¼–è¾‘æ¨¡å¼
- ä¿®æ”¹å®ŒæˆåæŒ‰ `ESC`
- è¾“å…¥ `:wq` ä¿å­˜å¹¶é€€å‡º
- å¦‚æœæé”™äº†æƒ³æ”¾å¼ƒ,è¾“å…¥ `:q!` ä¸ä¿å­˜é€€å‡º

**å¿…é¡»ä¿®æ”¹çš„é…ç½®é¡¹**:

```ini
# 1. æ•°æ®åº“é…ç½® - ä¿®æ”¹æ•°æ®åº“å¯†ç ä¸ºå¼ºå¯†ç 
DATABASE_URL=postgresql://postgres:ä½ çš„å¼ºå¯†ç @postgres:5432/uma_audit

# 2. Rediså¯†ç  - ä¿æŒåŸæ ·æˆ–æ”¹æˆæ›´å¤æ‚çš„
REDIS_PASSWORD=sZgikiiHFGkOzSPi4n3Bql_9PYrZst1y61hmxjOQ0Hw

# 3. å…³é—­è°ƒè¯•æ¨¡å¼
DEBUG=false

# 4. è®¾ç½®å…è®¸çš„åŸŸå (æ›¿æ¢æˆä½ çš„å®é™…åŸŸåæˆ–IP)
CORS_ORIGINS=["http://ä½ çš„åŸŸåæˆ–IP","https://ä½ çš„åŸŸåæˆ–IP"]

# 5. AIæœåŠ¡é…ç½® - å¡«å…¥ä½ çš„APIå¯†é’¥
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx  # å¦‚æœä½¿ç”¨OpenAI
DASHSCOPE_API_KEY=sk-cfea46e9f36c4aaba4a9030d2c618284  # é€šä¹‰åƒé—®å¯†é’¥

# 6. æ–‡ä»¶ä¸Šä¼ è·¯å¾„
UPLOAD_DIR=/app/uploads

# 7. æ—¥å¿—çº§åˆ«
LOG_LEVEL=INFO
```

### 5.3 å¿«é€Ÿé…ç½®æ–¹å¼ (æ¨è)

å¦‚æœä¸ç†Ÿæ‚‰vim,å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿæ›¿æ¢:

```bash
# æ›¿æ¢æ•°æ®åº“å¯†ç  (æ”¹æˆä½ çš„å¼ºå¯†ç )
sed -i 's/password@localhost/YourStrongPassword123!@postgres/g' .env.production

# å…³é—­è°ƒè¯•æ¨¡å¼
sed -i 's/DEBUG=true/DEBUG=false/g' .env.production

# è®¾ç½®CORS (æ›¿æ¢æˆä½ çš„IP)
sed -i 's|CORS_ORIGINS=.*|CORS_ORIGINS=["http://ä½ çš„IP:8000","http://ä½ çš„IP:3000"]|g' .env.production
```

### 5.4 åˆ›å»ºç”Ÿäº§ç¯å¢ƒDockeré…ç½®

åˆ›å»ºç”Ÿäº§ç¯å¢ƒä¸“ç”¨çš„docker-composeæ–‡ä»¶:

```bash
cat > docker-compose.prod.yml << 'EOF'
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14
    container_name: uma_audit_db_prod
    environment:
      POSTGRES_DB: uma_audit
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-YourStrongPassword123!}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: uma_audit_redis_prod
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # åç«¯APIæœåŠ¡
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: uma_audit_backend_prod
    ports:
      - "8000:8000"
    env_file:
      - .env.production
    environment:
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-YourStrongPassword123!}@postgres:5432/uma_audit
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DEBUG=false
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/logs:/app/logs
    restart: always

  # å‰ç«¯WebæœåŠ¡ (Nginxç”Ÿäº§æ¨¡å¼)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: uma_audit_frontend_prod
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
    restart: always

volumes:
  postgres_data:
  redis_data:
EOF
```

### 5.5 åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒDockerfile

```bash
# åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒæ„å»ºæ–‡ä»¶
cat > frontend/Dockerfile.prod << 'EOF'
# ç¬¬ä¸€é˜¶æ®µ: æ„å»º
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# ç¬¬äºŒé˜¶æ®µ: ç”Ÿäº§ç¯å¢ƒNginx
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
EOF
```

### 5.6 åˆ›å»ºNginxé…ç½®

```bash
# åˆ›å»ºnginxé…ç½®ç›®å½•
mkdir -p frontend/

# åˆ›å»ºnginxé…ç½®æ–‡ä»¶
cat > frontend/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/json application/javascript;

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # å‰ç«¯è·¯ç”±
        location / {
            try_files $uri $uri/ /index.html;
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF
```

---

## ç¬¬å…­æ­¥:å¯åŠ¨åº”ç”¨

### 6.1 æ„å»ºDockeré•œåƒ

```bash
# ç¡®ä¿åœ¨é¡¹ç›®ç›®å½•
cd /opt/uma-audit5

# æ„å»ºé•œåƒ (é¦–æ¬¡éœ€è¦5-10åˆ†é’Ÿ)
docker-compose -f docker-compose.prod.yml build

# æŸ¥çœ‹æ„å»ºç»“æœ
docker images
```

### 6.2 å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰å®¹å™¨
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

çœ‹åˆ°æ‰€æœ‰æœåŠ¡éƒ½æ˜¯ `Up` çŠ¶æ€å°±æˆåŠŸäº†:
```
NAME                        STATUS
uma_audit_backend_prod      Up
uma_audit_db_prod           Up (healthy)
uma_audit_frontend_prod     Up
uma_audit_redis_prod        Up (healthy)
```

### 6.3 æŸ¥çœ‹æ—¥å¿— (æ’æŸ¥é—®é¢˜)

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs

# åªçœ‹åç«¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
```

### 6.4 åˆå§‹åŒ–æ•°æ®åº“

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker exec -it uma_audit_backend_prod bash

# è¿è¡Œæ•°æ®åº“è¿ç§»
python -m alembic upgrade head

# åˆ›å»ºç®¡ç†å‘˜è´¦å· (å¯é€‰)
python scripts/create_admin.py

# é€€å‡ºå®¹å™¨
exit
```

### 6.5 æµ‹è¯•è®¿é—®

æ‰“å¼€æµè§ˆå™¨è®¿é—®:
- å‰ç«¯é¡µé¢: `http://ä½ çš„æœåŠ¡å™¨IP`
- åç«¯APIæ–‡æ¡£: `http://ä½ çš„æœåŠ¡å™¨IP:8000/docs`

èƒ½çœ‹åˆ°ç™»å½•é¡µé¢å°±æˆåŠŸäº†! ğŸ‰

---

## ç¬¬ä¸ƒæ­¥:é…ç½®åŸŸåå’ŒHTTPS (å¯é€‰ä½†æ¨è)

### 7.1 è´­ä¹°å’Œè§£æåŸŸå

1. åœ¨é˜¿é‡Œäº‘æˆ–å…¶ä»–åŸŸåæœåŠ¡å•†è´­ä¹°åŸŸå (ä¾‹å¦‚: `audit.example.com`)
2. åœ¨åŸŸåæ§åˆ¶å°æ·»åŠ Aè®°å½•:
   - è®°å½•ç±»å‹: `A`
   - ä¸»æœºè®°å½•: `@` (æˆ– `www`)
   - è®°å½•å€¼: `ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP`
   - TTL: `10åˆ†é’Ÿ`

ç­‰å¾…5-10åˆ†é’ŸDNSç”Ÿæ•ˆã€‚

### 7.2 ç”³è¯·å…è´¹SSLè¯ä¹¦

**æ–¹å¼ä¸€: ä½¿ç”¨Let's Encrypt (è‡ªåŠ¨åŒ–,å…è´¹)**

```bash
# å®‰è£…Certbot
apt install certbot python3-certbot-nginx -y

# åœæ­¢nginxå®¹å™¨ (ä¸´æ—¶)
docker stop uma_audit_frontend_prod

# ç”³è¯·è¯ä¹¦ (æ›¿æ¢æˆä½ çš„åŸŸåå’Œé‚®ç®±)
certbot certonly --standalone \
  -d audit.example.com \
  -d www.audit.example.com \
  --email your@email.com \
  --agree-tos

# è¯ä¹¦ä¿å­˜åœ¨: /etc/letsencrypt/live/audit.example.com/
```

**æ–¹å¼äºŒ: ä½¿ç”¨é˜¿é‡Œäº‘å…è´¹è¯ä¹¦**

1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å° â†’ SSLè¯ä¹¦ â†’ å…è´¹è¯ä¹¦
2. è´­ä¹°å…è´¹DVè¯ä¹¦ (20ä¸ª/å¹´)
3. å¡«å†™åŸŸåä¿¡æ¯,éªŒè¯åŸŸåæ‰€æœ‰æƒ
4. ä¸‹è½½è¯ä¹¦ (é€‰æ‹©Nginxæ ¼å¼)
5. ä¸Šä¼ åˆ°æœåŠ¡å™¨ `/opt/uma-audit5/nginx/ssl/` ç›®å½•

### 7.3 é…ç½®HTTPS

åˆ›å»ºæ”¯æŒHTTPSçš„Nginxé…ç½®:

```bash
cat > frontend/nginx-https.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/json application/javascript;

    # HTTPé‡å®šå‘åˆ°HTTPS
    server {
        listen 80;
        server_name audit.example.com www.audit.example.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPSæœåŠ¡å™¨
    server {
        listen 443 ssl http2;
        server_name audit.example.com www.audit.example.com;

        # SSLè¯ä¹¦é…ç½®
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        root /usr/share/nginx/html;
        index index.html;

        # å‰ç«¯è·¯ç”±
        location / {
            try_files $uri $uri/ /index.html;
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF
```

å¤åˆ¶è¯ä¹¦å¹¶é‡å¯:

```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
mkdir -p nginx/ssl

# å¤åˆ¶Let's Encryptè¯ä¹¦
cp /etc/letsencrypt/live/ä½ çš„åŸŸå/fullchain.pem nginx/ssl/
cp /etc/letsencrypt/live/ä½ çš„åŸŸå/privkey.pem nginx/ssl/

# æ›¿æ¢nginxé…ç½®
cp frontend/nginx-https.conf frontend/nginx.conf

# é‡æ–°æ„å»ºå‰ç«¯å®¹å™¨
docker-compose -f docker-compose.prod.yml up -d --build frontend
```

ç°åœ¨è®¿é—® `https://ä½ çš„åŸŸå` å°±å¯ä»¥çœ‹åˆ°ç»¿è‰²å°é”äº†! ğŸ”’

---

## ç¬¬å…«æ­¥:æ—¥å¸¸ç»´æŠ¤

### 8.1 å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml stop

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml start

# å®Œå…¨åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# æ›´æ–°ä»£ç åé‡æ–°æ„å»º
docker-compose -f docker-compose.prod.yml up -d --build
```

### 8.2 æ•°æ®å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /opt/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
docker exec uma_audit_db_prod pg_dump -U postgres uma_audit > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /opt/uma-audit5/backend/uploads

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $DATE"
EOF

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x /opt/backup.sh

# æ‰‹åŠ¨å¤‡ä»½
/opt/backup.sh

# è®¾ç½®è‡ªåŠ¨å¤‡ä»½ (æ¯å¤©å‡Œæ™¨2ç‚¹)
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/backup.sh") | crontab -
```

### 8.3 ç›‘æ§å’Œæ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æ¸…ç†Dockerå ç”¨ç©ºé—´
docker system prune -a
```

### 8.4 æ›´æ–°åº”ç”¨

å½“æœ‰æ–°ç‰ˆæœ¬æ—¶:

```bash
cd /opt/uma-audit5

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# è¿è¡Œæ•°æ®åº“è¿ç§»
docker exec -it uma_audit_backend_prod python -m alembic upgrade head
```

### 8.5 æ•…éšœæ’æŸ¥

**é—®é¢˜1: æ— æ³•è®¿é—®ç½‘ç«™**
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
docker-compose -f docker-compose.prod.yml ps

# æ£€æŸ¥é˜²ç«å¢™
ufw status

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tulpn | grep 80
```

**é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥**
```bash
# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker logs uma_audit_db_prod

# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker exec -it uma_audit_db_prod psql -U postgres
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# é‡å¯æœåŠ¡é‡Šæ”¾å†…å­˜
docker-compose -f docker-compose.prod.yml restart
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

**Q: å¿˜è®°äº†ç®¡ç†å‘˜å¯†ç æ€ä¹ˆåŠ?**
```bash
docker exec -it uma_audit_backend_prod python scripts/reset_password.py
```

**Q: å¦‚ä½•ä¿®æ”¹ç³»ç»Ÿé…ç½®?**
```bash
vim /opt/uma-audit5/.env.production
docker-compose -f docker-compose.prod.yml restart
```

**Q: å¦‚ä½•æŸ¥çœ‹é”™è¯¯æ—¥å¿—?**
```bash
# åç«¯æ—¥å¿—
docker logs uma_audit_backend_prod --tail 100

# å‰ç«¯æ—¥å¿—
docker logs uma_audit_frontend_prod --tail 100
```

**Q: SSLè¯ä¹¦å³å°†è¿‡æœŸæ€ä¹ˆåŠ?**
```bash
# Let's Encryptè‡ªåŠ¨ç»­æœŸ
certbot renew
docker-compose -f docker-compose.prod.yml restart frontend
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ä¼˜åŒ–**: å®šæœŸæ¸…ç†æ—§æ•°æ®,å»ºç«‹ç´¢å¼•
2. **ç¼“å­˜ä¼˜åŒ–**: åˆç†é…ç½®Redisç¼“å­˜æ—¶é—´
3. **CDNåŠ é€Ÿ**: ä½¿ç”¨é˜¿é‡Œäº‘CDNåŠ é€Ÿé™æ€èµ„æº
4. **è´Ÿè½½å‡è¡¡**: ç”¨æˆ·é‡å¤§æ—¶è€ƒè™‘å¤šæœåŠ¡å™¨éƒ¨ç½²

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆå,è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®:

- [ ] æœåŠ¡å™¨è´­ä¹°å¹¶é…ç½®å®Œæˆ
- [ ] å®‰å…¨ç»„è§„åˆ™è®¾ç½®æ­£ç¡®
- [ ] Dockerå’ŒDocker Composeå®‰è£…æˆåŠŸ
- [ ] é¡¹ç›®ä»£ç ä¸Šä¼ å®Œæˆ
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®ä¿®æ”¹å®Œæˆ
- [ ] æ‰€æœ‰Dockerå®¹å™¨æ­£å¸¸è¿è¡Œ
- [ ] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
- [ ] å¯ä»¥é€šè¿‡IPè®¿é—®å‰ç«¯é¡µé¢
- [ ] å¯ä»¥æ­£å¸¸ç™»å½•ç³»ç»Ÿ
- [ ] åŸŸåè§£æé…ç½® (å¦‚æœéœ€è¦)
- [ ] HTTPSè¯ä¹¦é…ç½® (å¦‚æœéœ€è¦)
- [ ] æ•°æ®å¤‡ä»½è„šæœ¬è®¾ç½®
- [ ] é˜²ç«å¢™å’Œå®‰å…¨ç»„é…ç½®æ­£ç¡®

---

## ğŸ‰ æ­å–œ!

å¦‚æœæ‰€æœ‰æ­¥éª¤éƒ½å®Œæˆäº†,ä½ çš„é€ ä»·å®¡è®¡ç³»ç»Ÿç°åœ¨å·²ç»æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘,å¯ä»¥ä¾›ä»–äººä½¿ç”¨äº†!

**ä¸‹ä¸€æ­¥å»ºè®®**:
1. åˆ›å»ºæµ‹è¯•è´¦å·,é‚€è¯·ç”¨æˆ·è¯•ç”¨
2. å®šæœŸæŸ¥çœ‹æ—¥å¿—,åŠæ—¶å‘ç°é—®é¢˜
3. è®¾ç½®ç›‘æ§å‘Šè­¦,ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ
4. å®šæœŸå¤‡ä»½æ•°æ®,é˜²æ­¢æ•°æ®ä¸¢å¤±

æœ‰ä»»ä½•é—®é¢˜,è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

---

ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
ğŸ“… **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
ğŸ‘¤ **é€‚ç”¨å¯¹è±¡**: éæŠ€æœ¯äººå‘˜
