# 造价审计系统 - 阿里云部署完整指南

> 📝 本指南专为非技术人员编写，每一步都有详细说明

---

## 📚 目录

1. [购买和准备阿里云服务器](#第一步购买和准备阿里云服务器)
2. [连接到服务器](#第二步连接到服务器)
3. [安装必要软件](#第三步安装必要软件)
4. [上传项目代码](#第四步上传项目代码)
5. [配置生产环境](#第五步配置生产环境)
6. [启动应用](#第六步启动应用)
7. [配置域名和HTTPS](#第七步配置域名和https可选但推荐)
8. [日常维护](#第八步日常维护)

---

## 第一步：购买和准备阿里云服务器

### 1.1 服务器配置推荐

访问 [阿里云官网](https://www.aliyun.com/) 购买ECS云服务器:

**最低配置** (适合测试/小规模使用):
- CPU: 2核
- 内存: 4GB
- 硬盘: 40GB (SSD)
- 带宽: 3Mbps
- 操作系统: **Ubuntu 22.04 64位** (重要！)
- 预算: 约100-200元/月

**推荐配置** (适合生产环境):
- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB (SSD)
- 带宽: 5Mbps
- 操作系统: **Ubuntu 22.04 64位**
- 预算: 约300-500元/月

### 1.2 购买时注意事项

✅ **必须勾选的项目**:
- 分配公网IP地址
- 设置安全组 (选择"放通常用端口")
- 记住你设置的**root密码** (非常重要!)

✅ **购买完成后记录以下信息**:
```
公网IP地址: ___________________  (例如: 47.98.123.45)
root密码: _____________________  (你设置的密码)
地域: _________________________  (例如: 华东1-杭州)
```

### 1.3 配置安全组规则

登录阿里云控制台 → 云服务器ECS → 网络与安全 → 安全组 → 配置规则

**需要开放的端口**:
| 端口号 | 说明 | 必须开放 |
|--------|------|----------|
| 22 | SSH远程登录 | ✅ 是 |
| 80 | HTTP网站访问 | ✅ 是 |
| 443 | HTTPS安全访问 | ✅ 是 |
| 8000 | 后端API端口 | ✅ 是 |
| 3000 | 前端端口(临时) | ⚠️ 可选 |

**添加规则示例**:
```
规则方向: 入方向
授权策略: 允许
协议类型: TCP
端口范围: 80/80
授权对象: 0.0.0.0/0
描述: HTTP访问
```

对22、443、8000等端口重复以上操作。

---

## 第二步:连接到服务器

### 2.1 Windows用户 - 使用Xshell或PuTTY

**推荐使用Xshell** (免费,中文界面):

1. 下载并安装 [Xshell](https://www.xshell.com/zh/free-for-home-school/)
2. 打开Xshell,点击"新建"
3. 填写连接信息:
   - 名称: `阿里云审计系统`
   - 协议: `SSH`
   - 主机: `你的公网IP地址`
   - 端口号: `22`
4. 点击"用户身份验证":
   - 方法: `Password`
   - 用户名: `root`
   - 密码: `你设置的root密码`
5. 点击"连接"

**首次连接会提示**: "SSH安全警告" → 点击"接受并保存"

连接成功后,你会看到命令行界面:
```
Welcome to Ubuntu 22.04 LTS
root@iZxxxxxxxxxZ:~#
```

### 2.2 Mac用户 - 使用终端

1. 打开"终端"应用 (应用程序 → 实用工具 → 终端)
2. 输入以下命令 (替换成你的IP地址):
   ```bash
   ssh root@你的公网IP地址
   ```
3. 输入密码 (输入时不显示,直接输入后按回车)

---

## 第三步:安装必要软件

连接到服务器后,**逐行复制粘贴**以下命令执行。

### 3.1 更新系统

```bash
# 更新软件包列表
apt update

# 升级已安装的软件
apt upgrade -y
```

等待完成 (可能需要5-10分钟)

### 3.2 安装Docker和Docker Compose

Docker可以让你一键启动所有服务,非常方便!

```bash
# 安装Docker
curl -fsSL https://get.docker.com | bash

# 启动Docker服务
systemctl start docker
systemctl enable docker

# 安装Docker Compose
apt install docker-compose -y

# 验证安装
docker --version
docker-compose --version
```

看到版本号就表示安装成功! 例如:
```
Docker version 24.0.5
docker-compose version 1.29.2
```

### 3.3 安装其他工具

```bash
# 安装Git (用于代码管理)
apt install git -y

# 安装unzip (用于解压文件)
apt install unzip -y

# 安装vim编辑器
apt install vim -y
```

---

## 第四步:上传项目代码

有两种方式上传代码到服务器,选择你喜欢的:

### 方式一:使用Git (推荐)

如果你的代码在GitHub/Gitee上:

```bash
# 进入工作目录
cd /opt

# 克隆项目 (替换成你的仓库地址)
git clone https://github.com/你的用户名/uma-audit5.git

# 进入项目目录
cd uma-audit5
```

### 方式二:使用FTP上传 (更直观)

**Windows用户 - 使用WinSCP**:

1. 下载安装 [WinSCP](https://winscp.net/eng/download.php)
2. 打开WinSCP,新建站点:
   - 文件协议: `SFTP`
   - 主机名: `你的公网IP`
   - 端口号: `22`
   - 用户名: `root`
   - 密码: `你的root密码`
3. 点击"登录"
4. 左侧是你的电脑,右侧是服务器
5. 在右侧进入 `/opt` 目录
6. 将你本地的 `uma-audit5` 文件夹拖拽到右侧

**Mac用户 - 使用FileZilla**:

1. 下载安装 [FileZilla](https://filezilla-project.org/)
2. 主机: `sftp://你的公网IP`
3. 用户名: `root`
4. 密码: `你的root密码`
5. 端口: `22`
6. 上传整个项目文件夹到 `/opt`

上传完成后,在SSH终端执行:
```bash
cd /opt/uma-audit5
ls -la
```

能看到项目文件就表示上传成功!

---

## 第五步:配置生产环境

### 5.1 创建生产环境配置文件

```bash
# 确保在项目目录
cd /opt/uma-audit5

# 复制环境变量文件
cp .env .env.production
```

### 5.2 修改配置文件

使用vim编辑器 (如果不熟悉,可以用下面的"快速配置方式"):

```bash
vim .env.production
```

**vim基本操作**:
- 按 `i` 进入编辑模式
- 修改完成后按 `ESC`
- 输入 `:wq` 保存并退出
- 如果搞错了想放弃,输入 `:q!` 不保存退出

**必须修改的配置项**:

```ini
# 1. 数据库配置 - 修改数据库密码为强密码
DATABASE_URL=postgresql://postgres:你的强密码@postgres:5432/uma_audit

# 2. Redis密码 - 保持原样或改成更复杂的
REDIS_PASSWORD=sZgikiiHFGkOzSPi4n3Bql_9PYrZst1y61hmxjOQ0Hw

# 3. 关闭调试模式
DEBUG=false

# 4. 设置允许的域名 (替换成你的实际域名或IP)
CORS_ORIGINS=["http://你的域名或IP","https://你的域名或IP"]

# 5. AI服务配置 - 填入你的API密钥
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx  # 如果使用OpenAI
DASHSCOPE_API_KEY=sk-cfea46e9f36c4aaba4a9030d2c618284  # 通义千问密钥

# 6. 文件上传路径
UPLOAD_DIR=/app/uploads

# 7. 日志级别
LOG_LEVEL=INFO
```

### 5.3 快速配置方式 (推荐)

如果不熟悉vim,可以用以下命令快速替换:

```bash
# 替换数据库密码 (改成你的强密码)
sed -i 's/password@localhost/YourStrongPassword123!@postgres/g' .env.production

# 关闭调试模式
sed -i 's/DEBUG=true/DEBUG=false/g' .env.production

# 设置CORS (替换成你的IP)
sed -i 's|CORS_ORIGINS=.*|CORS_ORIGINS=["http://你的IP:8000","http://你的IP:3000"]|g' .env.production
```

### 5.4 创建生产环境Docker配置

创建生产环境专用的docker-compose文件:

```bash
cat > docker-compose.prod.yml << 'EOF'
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:14
    container_name: uma_audit_db_prod
    environment:
      POSTGRES_DB: uma_audit
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-YourStrongPassword123!}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: uma_audit_redis_prod
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 后端API服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: uma_audit_backend_prod
    ports:
      - "8000:8000"
    env_file:
      - .env.production
    environment:
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-YourStrongPassword123!}@postgres:5432/uma_audit
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DEBUG=false
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/logs:/app/logs
    restart: always

  # 前端Web服务 (Nginx生产模式)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: uma_audit_frontend_prod
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
    restart: always

volumes:
  postgres_data:
  redis_data:
EOF
```

### 5.5 创建前端生产环境Dockerfile

```bash
# 创建前端生产环境构建文件
cat > frontend/Dockerfile.prod << 'EOF'
# 第一阶段: 构建
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 第二阶段: 生产环境Nginx
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
EOF
```

### 5.6 创建Nginx配置

```bash
# 创建nginx配置目录
mkdir -p frontend/

# 创建nginx配置文件
cat > frontend/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/json application/javascript;

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # 前端路由
        location / {
            try_files $uri $uri/ /index.html;
        }

        # API代理
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF
```

---

## 第六步:启动应用

### 6.1 构建Docker镜像

```bash
# 确保在项目目录
cd /opt/uma-audit5

# 构建镜像 (首次需要5-10分钟)
docker-compose -f docker-compose.prod.yml build

# 查看构建结果
docker images
```

### 6.2 启动所有服务

```bash
# 启动所有容器
docker-compose -f docker-compose.prod.yml up -d

# 查看运行状态
docker-compose -f docker-compose.prod.yml ps
```

看到所有服务都是 `Up` 状态就成功了:
```
NAME                        STATUS
uma_audit_backend_prod      Up
uma_audit_db_prod           Up (healthy)
uma_audit_frontend_prod     Up
uma_audit_redis_prod        Up (healthy)
```

### 6.3 查看日志 (排查问题)

```bash
# 查看所有日志
docker-compose -f docker-compose.prod.yml logs

# 只看后端日志
docker-compose -f docker-compose.prod.yml logs backend

# 实时查看日志
docker-compose -f docker-compose.prod.yml logs -f backend
```

### 6.4 初始化数据库

```bash
# 进入后端容器
docker exec -it uma_audit_backend_prod bash

# 运行数据库迁移
python -m alembic upgrade head

# 创建管理员账号 (可选)
python scripts/create_admin.py

# 退出容器
exit
```

### 6.5 测试访问

打开浏览器访问:
- 前端页面: `http://你的服务器IP`
- 后端API文档: `http://你的服务器IP:8000/docs`

能看到登录页面就成功了! 🎉

---

## 第七步:配置域名和HTTPS (可选但推荐)

### 7.1 购买和解析域名

1. 在阿里云或其他域名服务商购买域名 (例如: `audit.example.com`)
2. 在域名控制台添加A记录:
   - 记录类型: `A`
   - 主机记录: `@` (或 `www`)
   - 记录值: `你的服务器公网IP`
   - TTL: `10分钟`

等待5-10分钟DNS生效。

### 7.2 申请免费SSL证书

**方式一: 使用Let's Encrypt (自动化,免费)**

```bash
# 安装Certbot
apt install certbot python3-certbot-nginx -y

# 停止nginx容器 (临时)
docker stop uma_audit_frontend_prod

# 申请证书 (替换成你的域名和邮箱)
certbot certonly --standalone \
  -d audit.example.com \
  -d www.audit.example.com \
  --email your@email.com \
  --agree-tos

# 证书保存在: /etc/letsencrypt/live/audit.example.com/
```

**方式二: 使用阿里云免费证书**

1. 登录阿里云控制台 → SSL证书 → 免费证书
2. 购买免费DV证书 (20个/年)
3. 填写域名信息,验证域名所有权
4. 下载证书 (选择Nginx格式)
5. 上传到服务器 `/opt/uma-audit5/nginx/ssl/` 目录

### 7.3 配置HTTPS

创建支持HTTPS的Nginx配置:

```bash
cat > frontend/nginx-https.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/json application/javascript;

    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name audit.example.com www.audit.example.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS服务器
    server {
        listen 443 ssl http2;
        server_name audit.example.com www.audit.example.com;

        # SSL证书配置
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        root /usr/share/nginx/html;
        index index.html;

        # 前端路由
        location / {
            try_files $uri $uri/ /index.html;
        }

        # API代理
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF
```

复制证书并重启:

```bash
# 创建证书目录
mkdir -p nginx/ssl

# 复制Let's Encrypt证书
cp /etc/letsencrypt/live/你的域名/fullchain.pem nginx/ssl/
cp /etc/letsencrypt/live/你的域名/privkey.pem nginx/ssl/

# 替换nginx配置
cp frontend/nginx-https.conf frontend/nginx.conf

# 重新构建前端容器
docker-compose -f docker-compose.prod.yml up -d --build frontend
```

现在访问 `https://你的域名` 就可以看到绿色小锁了! 🔒

---

## 第八步:日常维护

### 8.1 常用命令

```bash
# 查看运行状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 停止所有服务
docker-compose -f docker-compose.prod.yml stop

# 启动所有服务
docker-compose -f docker-compose.prod.yml start

# 完全停止并删除容器
docker-compose -f docker-compose.prod.yml down

# 更新代码后重新构建
docker-compose -f docker-compose.prod.yml up -d --build
```

### 8.2 数据备份

```bash
# 创建备份脚本
cat > /opt/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker exec uma_audit_db_prod pg_dump -U postgres uma_audit > $BACKUP_DIR/db_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /opt/uma-audit5/backend/uploads

# 删除30天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $DATE"
EOF

# 给脚本执行权限
chmod +x /opt/backup.sh

# 手动备份
/opt/backup.sh

# 设置自动备份 (每天凌晨2点)
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/backup.sh") | crontab -
```

### 8.3 监控和日志

```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 清理Docker占用空间
docker system prune -a
```

### 8.4 更新应用

当有新版本时:

```bash
cd /opt/uma-audit5

# 拉取最新代码
git pull

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up -d --build

# 运行数据库迁移
docker exec -it uma_audit_backend_prod python -m alembic upgrade head
```

### 8.5 故障排查

**问题1: 无法访问网站**
```bash
# 检查服务是否运行
docker-compose -f docker-compose.prod.yml ps

# 检查防火墙
ufw status

# 检查端口是否开放
netstat -tulpn | grep 80
```

**问题2: 数据库连接失败**
```bash
# 查看数据库日志
docker logs uma_audit_db_prod

# 进入数据库容器
docker exec -it uma_audit_db_prod psql -U postgres
```

**问题3: 内存不足**
```bash
# 查看内存使用
free -h

# 重启服务释放内存
docker-compose -f docker-compose.prod.yml restart
```

---

## 📞 技术支持

### 常见问题

**Q: 忘记了管理员密码怎么办?**
```bash
docker exec -it uma_audit_backend_prod python scripts/reset_password.py
```

**Q: 如何修改系统配置?**
```bash
vim /opt/uma-audit5/.env.production
docker-compose -f docker-compose.prod.yml restart
```

**Q: 如何查看错误日志?**
```bash
# 后端日志
docker logs uma_audit_backend_prod --tail 100

# 前端日志
docker logs uma_audit_frontend_prod --tail 100
```

**Q: SSL证书即将过期怎么办?**
```bash
# Let's Encrypt自动续期
certbot renew
docker-compose -f docker-compose.prod.yml restart frontend
```

### 性能优化建议

1. **数据库优化**: 定期清理旧数据,建立索引
2. **缓存优化**: 合理配置Redis缓存时间
3. **CDN加速**: 使用阿里云CDN加速静态资源
4. **负载均衡**: 用户量大时考虑多服务器部署

---

## ✅ 部署检查清单

部署完成后,请检查以下项目:

- [ ] 服务器购买并配置完成
- [ ] 安全组规则设置正确
- [ ] Docker和Docker Compose安装成功
- [ ] 项目代码上传完成
- [ ] 生产环境配置修改完成
- [ ] 所有Docker容器正常运行
- [ ] 数据库初始化完成
- [ ] 可以通过IP访问前端页面
- [ ] 可以正常登录系统
- [ ] 域名解析配置 (如果需要)
- [ ] HTTPS证书配置 (如果需要)
- [ ] 数据备份脚本设置
- [ ] 防火墙和安全组配置正确

---

## 🎉 恭喜!

如果所有步骤都完成了,你的造价审计系统现在已经成功部署到阿里云,可以供他人使用了!

**下一步建议**:
1. 创建测试账号,邀请用户试用
2. 定期查看日志,及时发现问题
3. 设置监控告警,确保系统稳定运行
4. 定期备份数据,防止数据丢失

有任何问题,请查看日志文件或联系技术支持。

---

📝 **文档版本**: v1.0
📅 **更新时间**: 2025年1月
👤 **适用对象**: 非技术人员
