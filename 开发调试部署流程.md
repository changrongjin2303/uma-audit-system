# 🔄 造价审计系统 - 开发调试部署完整流程

> 📝 如何在本地开发调试，然后同步到阿里云服务器

---

## 📚 目录

1. [开发流程总览](#开发流程总览)
2. [本地开发环境](#本地开发环境)
3. [代码同步方法](#代码同步方法)
4. [更新部署流程](#更新部署流程)
5. [版本管理建议](#版本管理建议)
6. [常见场景处理](#常见场景处理)

---

## 开发流程总览

### 🎯 标准开发流程

```
┌─────────────────────────────────────────────────────────┐
│                    完整开发流程图                        │
└─────────────────────────────────────────────────────────┘

      本地开发环境                     云服务器环境
    ┌──────────────┐                ┌──────────────┐
    │              │                │              │
    │  📝 编写代码  │                │              │
    │  🐛 本地调试  │                │  🌐 生产环境  │
    │  ✅ 功能测试  │                │  👥 用户使用  │
    │              │                │              │
    └──────┬───────┘                └──────▲───────┘
           │                               │
           │  ① 代码修改完成                │
           │  ② 本地测试通过                │
           ▼                               │
    ┌──────────────┐                      │
    │  💾 提交代码  │                      │
    │  (Git)       │                      │
    └──────┬───────┘                      │
           │                               │
           │  ③ 推送到代码仓库              │
           │  (GitHub/Gitee)               │
           ▼                               │
    ┌──────────────┐                      │
    │  📦 代码仓库  │                      │
    │  (GitHub)    │                      │
    └──────┬───────┘                      │
           │                               │
           │  ④ SSH连接云服务器             │
           │  ⑤ 拉取最新代码               │
           │  ⑥ 重新构建部署               │
           └───────────────────────────────┘
```

### ✨ 推荐工作流程

```
第一步: 本地开发
  ├─ 在你的Mac电脑上修改代码
  ├─ 使用Docker启动本地环境测试
  ├─ 确保功能正常，没有bug
  └─ 提交代码到Git仓库

第二步: 代码同步
  ├─ 推送代码到GitHub/Gitee
  └─ 或直接用FTP上传到服务器

第三步: 服务器部署
  ├─ SSH连接到阿里云服务器
  ├─ 拉取最新代码
  ├─ 重新构建并重启服务
  └─ 验证功能正常
```

---

## 本地开发环境

### 1. 本地环境配置

你的Mac电脑已经有本地开发环境，继续使用即可：

#### 当前本地环境

```bash
# 你现在的开发目录
/Users/crj/Documents/code/uma-audit5/

# 本地运行方式
cd /Users/crj/Documents/code/uma-audit5
./start.sh  # 或其他启动脚本
```

#### 本地访问地址

```
前端: http://localhost:3000
后端: http://localhost:8000
API文档: http://localhost:8000/docs
```

### 2. 本地开发流程

```bash
# 1. 修改代码
# 使用你喜欢的编辑器 (VSCode, Cursor等)
# 修改 backend/ 或 frontend/ 中的文件

# 2. 启动本地服务
./start.sh

# 3. 浏览器访问测试
# http://localhost:3000

# 4. 查看日志调试
docker-compose logs -f

# 5. 测试功能是否正常
# - 登录系统
# - 测试修改的功能
# - 确保没有错误

# 6. 停止服务
./stop.sh
```

### 3. 本地测试检查清单

```
修改完成后，请检查:

前端修改:
  ☐ 页面显示正常
  ☐ 没有控制台错误
  ☐ 响应式布局正常
  ☐ 与后端交互正常

后端修改:
  ☐ API接口测试通过
  ☐ 数据库操作正常
  ☐ 没有Python错误
  ☐ 日志没有异常

全面测试:
  ☐ 核心功能测试通过
  ☐ 新功能工作正常
  ☐ 旧功能没有被破坏
  ☐ 性能没有明显下降
```

---

## 代码同步方法

### 方式一: Git版本管理 (强烈推荐⭐⭐⭐⭐⭐)

这是最专业、最安全的方式！

#### 1️⃣ 首次配置Git

```bash
# 在本地项目目录
cd /Users/crj/Documents/code/uma-audit5

# 初始化Git仓库 (如果还没有)
git init

# 配置用户信息
git config user.name "你的名字"
git config user.email "your@email.com"

# 创建.gitignore文件 (忽略不需要上传的文件)
cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*.so
.Python
env/
venv/
*.egg-info/
.pytest_cache/

# Node
node_modules/
dist/
.npm
.cache/

# 环境变量和密钥 (重要！)
.env
.env.production
*.pem
*.key
*.crt

# 数据库和上传文件
*.db
*.sqlite
uploads/
logs/
backups/

# IDE
.vscode/
.idea/
*.swp
*.swo

# 系统文件
.DS_Store
Thumbs.db

# Docker
postgres_data/
redis_data/
EOF
```

#### 2️⃣ 创建GitHub/Gitee仓库

**使用GitHub**:
1. 访问 https://github.com/
2. 点击 "New repository"
3. 仓库名: `uma-audit-system`
4. 设置为 **Private** (私有仓库，保护代码)
5. 点击 "Create repository"

**使用Gitee** (国内访问更快):
1. 访问 https://gitee.com/
2. 点击 "新建仓库"
3. 仓库名: `uma-audit-system`
4. 设置为 **私有**
5. 点击 "创建"

#### 3️⃣ 关联远程仓库

```bash
# 添加所有文件
git add .

# 第一次提交
git commit -m "初始提交：造价审计系统"

# 关联远程仓库 (选择一个)
# GitHub:
git remote add origin https://github.com/你的用户名/uma-audit-system.git

# 或 Gitee:
git remote add origin https://gitee.com/你的用户名/uma-audit-system.git

# 推送到远程
git push -u origin main
```

#### 4️⃣ 日常开发流程

```bash
# 修改代码后...

# 查看修改了哪些文件
git status

# 添加修改的文件
git add .

# 提交修改 (写清楚改了什么)
git commit -m "修复：价格分析功能的计算错误"

# 推送到远程仓库
git push

# 完成！代码已保存到GitHub/Gitee
```

#### 5️⃣ 在服务器上拉取代码

```bash
# SSH连接到阿里云服务器
ssh root@你的服务器IP

# 进入项目目录
cd /opt/uma-audit5

# 首次克隆 (只需要一次)
# git clone https://github.com/你的用户名/uma-audit-system.git .

# 以后每次拉取最新代码
git pull

# 重新构建部署
docker-compose -f docker-compose.prod.yml up -d --build
```

---

### 方式二: FTP/SFTP直接上传 (简单快速⭐⭐⭐⭐)

适合小改动，不想用Git的情况。

#### Windows - 使用WinSCP

```
1. 打开WinSCP
2. 连接到服务器
3. 左侧: 本地修改的文件
4. 右侧: 服务器对应目录
5. 直接拖拽上传
6. SSH执行重启命令
```

#### Mac - 使用scp命令

```bash
# 上传单个文件
scp backend/main.py root@服务器IP:/opt/uma-audit5/backend/

# 上传整个目录
scp -r backend/app root@服务器IP:/opt/uma-audit5/backend/

# 上传多个文件
scp backend/main.py backend/config.py root@服务器IP:/opt/uma-audit5/backend/
```

#### 上传后重启服务

```bash
# SSH连接服务器
ssh root@服务器IP

# 进入项目目录
cd /opt/uma-audit5

# 只修改了代码，不需要重新构建
docker-compose -f docker-compose.prod.yml restart backend

# 如果修改了依赖或Dockerfile，需要重新构建
docker-compose -f docker-compose.prod.yml up -d --build backend
```

---

### 方式三: 使用rsync同步 (高级⭐⭐⭐)

适合经常同步，想要自动化的情况。

```bash
# 安装rsync (Mac通常已安装)
# Windows需要安装Git Bash或WSL

# 同步整个项目 (排除不需要的文件)
rsync -avz --exclude='node_modules' \
           --exclude='__pycache__' \
           --exclude='.git' \
           --exclude='uploads' \
           --exclude='logs' \
           /Users/crj/Documents/code/uma-audit5/ \
           root@服务器IP:/opt/uma-audit5/

# 创建同步脚本
cat > sync-to-server.sh << 'EOF'
#!/bin/bash
echo "开始同步代码到服务器..."
rsync -avz --exclude='node_modules' \
           --exclude='__pycache__' \
           --exclude='.git' \
           --exclude='uploads' \
           --exclude='logs' \
           --exclude='.env' \
           ./ root@你的服务器IP:/opt/uma-audit5/

echo "同步完成！"
echo "现在需要SSH到服务器重启服务"
EOF

chmod +x sync-to-server.sh

# 以后每次同步只需运行
./sync-to-server.sh
```

---

## 更新部署流程

### 完整更新流程

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u521b\u5efa\u672c\u5730\u5f00\u53d1\u73af\u5883\u6307\u5357", "status": "completed", "activeForm": "\u521b\u5efa\u672c\u5730\u5f00\u53d1\u73af\u5883\u6307\u5357"}, {"content": "\u521b\u5efa\u4ee3\u7801\u540c\u6b65\u90e8\u7f72\u6d41\u7a0b\u6587\u6863", "status": "in_progress", "activeForm": "\u521b\u5efa\u4ee3\u7801\u540c\u6b65\u90e8\u7f72\u6d41\u7a0b\u6587\u6863"}, {"content": "\u521b\u5efa\u7248\u672c\u7ba1\u7406\u6307\u5357", "status": "pending", "activeForm": "\u521b\u5efa\u7248\u672c\u7ba1\u7406\u6307\u5357"}, {"content": "\u521b\u5efa\u5feb\u901f\u66f4\u65b0\u811a\u672c", "status": "pending", "activeForm": "\u521b\u5efa\u5feb\u901f\u66f4\u65b0\u811a\u672c"}]