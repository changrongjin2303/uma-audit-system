# 阿里云部署快速参考卡片

> 📌 已经部署好的系统日常维护速查表

---

## 🚀 一键部署

### 首次部署 (在阿里云服务器上执行)

```bash
# 1. 上传项目到服务器 /opt/uma-audit5 目录
# 2. 进入项目目录
cd /opt/uma-audit5

# 3. 运行一键部署脚本
./deploy-to-aliyun.sh
```

---

## 📋 常用命令

### 服务管理

```bash
# 进入项目目录
cd /opt/uma-audit5

# 启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 停止所有服务
docker-compose -f docker-compose.prod.yml stop

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 查看服务运行状态
docker-compose -f docker-compose.prod.yml ps

# 查看服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看某个服务的日志 (如后端)
docker-compose -f docker-compose.prod.yml logs -f backend

# 停止并删除所有容器
docker-compose -f docker-compose.prod.yml down
```

### 单个服务管理

```bash
# 重启后端服务
docker-compose -f docker-compose.prod.yml restart backend

# 重启前端服务
docker-compose -f docker-compose.prod.yml restart frontend

# 重启数据库
docker-compose -f docker-compose.prod.yml restart postgres

# 重启Redis
docker-compose -f docker-compose.prod.yml restart redis
```

### 查看日志

```bash
# 查看最新100行日志
docker-compose -f docker-compose.prod.yml logs --tail=100

# 实时查看日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看错误日志
docker-compose -f docker-compose.prod.yml logs | grep -i error

# 查看特定时间的日志
docker-compose -f docker-compose.prod.yml logs --since="2025-01-20T10:00:00"
```

---

## 🔧 系统维护

### 健康检查

```bash
# 运行健康检查脚本
./health-check.sh

# 手动检查各服务
docker ps                           # 查看容器状态
docker stats                        # 查看资源使用
df -h                               # 查看磁盘空间
free -h                             # 查看内存使用
```

### 数据备份

```bash
# 运行备份脚本
./backup-data.sh

# 手动备份数据库
docker exec uma_audit_db_prod pg_dump -U postgres uma_audit > backup.sql

# 手动备份上传文件
tar -czf uploads_backup.tar.gz ./backend/uploads

# 设置每天自动备份 (凌晨2点)
crontab -e
# 添加: 0 2 * * * /opt/uma-audit5/backup-data.sh
```

### 数据恢复

```bash
# 恢复数据库
docker exec -i uma_audit_db_prod psql -U postgres uma_audit < backup.sql

# 恢复上传文件
tar -xzf uploads_backup.tar.gz -C ./backend/
```

---

## 🔄 更新部署

### 更新代码

```bash
cd /opt/uma-audit5

# 方式一: Git拉取 (如果使用Git)
git pull

# 方式二: 手动上传新代码 (使用WinSCP/FileZilla)

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up -d --build

# 运行数据库迁移
docker exec -it uma_audit_backend_prod python -m alembic upgrade head
```

### 更新配置

```bash
# 修改配置文件
vim .env.production

# 重启服务使配置生效
docker-compose -f docker-compose.prod.yml restart
```

---

## 🐛 故障排查

### 1. 网站打不开

```bash
# 检查服务是否运行
docker-compose -f docker-compose.prod.yml ps

# 检查端口是否开放
netstat -tuln | grep 80
netstat -tuln | grep 8000

# 检查防火墙
ufw status

# 检查安全组 (在阿里云控制台)
```

### 2. 数据库连接失败

```bash
# 查看数据库日志
docker logs uma_audit_db_prod

# 进入数据库容器
docker exec -it uma_audit_db_prod psql -U postgres

# 检查数据库状态
docker exec uma_audit_db_prod pg_isready -U postgres
```

### 3. 后端API错误

```bash
# 查看后端日志
docker logs uma_audit_backend_prod --tail 100

# 进入后端容器
docker exec -it uma_audit_backend_prod bash

# 查看错误日志文件
docker exec uma_audit_backend_prod cat logs/error.log
```

### 4. 前端页面空白

```bash
# 查看前端日志
docker logs uma_audit_frontend_prod

# 检查Nginx配置
docker exec uma_audit_frontend_prod nginx -t

# 重启前端服务
docker-compose -f docker-compose.prod.yml restart frontend
```

### 5. 内存不足

```bash
# 查看内存使用
free -h

# 查看容器内存使用
docker stats

# 清理Docker占用空间
docker system prune -a

# 重启服务释放内存
docker-compose -f docker-compose.prod.yml restart
```

### 6. 磁盘空间不足

```bash
# 查看磁盘使用
df -h

# 查看大文件
du -sh /opt/uma-audit5/* | sort -rh | head -10

# 清理日志文件
find ./backend/logs -name "*.log" -mtime +7 -delete

# 清理旧备份
find /opt/backups -mtime +30 -delete

# 清理Docker
docker system prune -a --volumes
```

---

## 🔐 安全相关

### 修改密码

```bash
# 修改数据库密码
docker exec -it uma_audit_db_prod psql -U postgres
ALTER USER postgres PASSWORD 'new_password';

# 修改配置文件中的密码
vim .env.production
# 修改 DATABASE_URL 中的密码

# 重启服务
docker-compose -f docker-compose.prod.yml restart
```

### 查看访问日志

```bash
# 查看Nginx访问日志
docker exec uma_audit_frontend_prod cat /var/log/nginx/access.log

# 查看Nginx错误日志
docker exec uma_audit_frontend_prod cat /var/log/nginx/error.log

# 查看后端访问日志
docker exec uma_audit_backend_prod cat logs/access.log
```

---

## 📊 监控命令

### 实时监控

```bash
# 监控容器资源
docker stats

# 监控系统资源
htop  # 需要安装: apt install htop

# 监控磁盘IO
iotop  # 需要安装: apt install iotop

# 监控网络流量
iftop  # 需要安装: apt install iftop
```

### 性能分析

```bash
# 查看数据库连接数
docker exec uma_audit_db_prod psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 查看Redis连接数
docker exec uma_audit_redis_prod redis-cli INFO clients

# 查看API响应时间 (查看日志)
docker-compose -f docker-compose.prod.yml logs backend | grep "ms"
```

---

## 🌐 域名和HTTPS

### 配置域名

```bash
# 1. 在域名服务商添加A记录
# 记录类型: A
# 主机记录: @
# 记录值: 服务器IP

# 2. 等待DNS生效 (5-10分钟)
ping your-domain.com
```

### 配置SSL证书 (Let's Encrypt)

```bash
# 安装Certbot
apt install certbot python3-certbot-nginx -y

# 停止nginx容器
docker stop uma_audit_frontend_prod

# 申请证书
certbot certonly --standalone \
  -d your-domain.com \
  -d www.your-domain.com \
  --email your@email.com \
  --agree-tos

# 证书路径
/etc/letsencrypt/live/your-domain.com/fullchain.pem
/etc/letsencrypt/live/your-domain.com/privkey.pem

# 复制证书
mkdir -p nginx/ssl
cp /etc/letsencrypt/live/your-domain.com/fullchain.pem nginx/ssl/
cp /etc/letsencrypt/live/your-domain.com/privkey.pem nginx/ssl/

# 更新Nginx配置 (参考部署指南)
# 重启前端服务
docker-compose -f docker-compose.prod.yml up -d --build frontend
```

### 自动续期证书

```bash
# 测试续期
certbot renew --dry-run

# 设置自动续期 (每月1号凌晨3点)
crontab -e
# 添加: 0 3 1 * * certbot renew --quiet && docker-compose -f /opt/uma-audit5/docker-compose.prod.yml restart frontend
```

---

## 📞 紧急情况处理

### 系统完全无响应

```bash
# 1. 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 2. 如果仍无响应,完全重启
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# 3. 如果仍有问题,重启服务器
reboot
```

### 数据库损坏

```bash
# 1. 停止后端服务
docker-compose -f docker-compose.prod.yml stop backend

# 2. 从备份恢复
docker exec -i uma_audit_db_prod psql -U postgres uma_audit < /opt/backups/uma-audit/database_YYYYMMDD_HHMMSS.sql

# 3. 重启服务
docker-compose -f docker-compose.prod.yml start backend
```

### 磁盘已满

```bash
# 1. 紧急清理
docker system prune -a --volumes
rm -rf /opt/uma-audit5/backend/logs/*
find /opt/backups -mtime +7 -delete

# 2. 扩容磁盘 (在阿里云控制台)
```

---

## 📱 访问地址

### 默认访问

- 前端: `http://服务器IP`
- 后端API文档: `http://服务器IP:8000/docs`
- 后端管理后台: `http://服务器IP:8000/admin` (如果有)

### 域名访问 (配置后)

- 前端: `https://your-domain.com`
- 后端API: `https://your-domain.com/api`

---

## 📚 详细文档

- 完整部署指南: `阿里云部署指南.md`
- 项目开发文档: `CLAUDE.md`
- API文档: `http://服务器IP:8000/docs`

---

## 🆘 获取帮助

### 查看系统信息

```bash
# 系统版本
cat /etc/os-release

# Docker版本
docker --version
docker-compose --version

# 项目版本
cat /opt/uma-audit5/VERSION  # 如果有

# 服务器信息
uname -a
```

### 导出诊断信息

```bash
# 创建诊断报告
cat > /tmp/diagnostic_report.txt << EOF
=== 系统信息 ===
$(uname -a)
$(cat /etc/os-release)

=== Docker信息 ===
$(docker --version)
$(docker-compose --version)

=== 容器状态 ===
$(docker ps -a)

=== 资源使用 ===
$(free -h)
$(df -h)

=== 服务日志 (最近50行) ===
$(docker-compose -f /opt/uma-audit5/docker-compose.prod.yml logs --tail=50)
EOF

# 查看报告
cat /tmp/diagnostic_report.txt
```

---

**提示**:
- 所有命令都需要在项目目录 `/opt/uma-audit5` 下执行
- 生产环境使用 `docker-compose.prod.yml` 文件
- 重要操作前记得先备份数据
- 不确定的操作请先查看详细文档

**文档版本**: v1.0
**更新时间**: 2025年1月
