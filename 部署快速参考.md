# é˜¿é‡Œäº‘éƒ¨ç½²å¿«é€Ÿå‚è€ƒå¡ç‰‡

> ğŸ“Œ å·²ç»éƒ¨ç½²å¥½çš„ç³»ç»Ÿæ—¥å¸¸ç»´æŠ¤é€ŸæŸ¥è¡¨

---

## ğŸš€ ä¸€é”®éƒ¨ç½²

### é¦–æ¬¡éƒ¨ç½² (åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ‰§è¡Œ)

```bash
# 1. ä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨ /opt/uma-audit5 ç›®å½•
# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/uma-audit5

# 3. è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬
./deploy-to-aliyun.sh
```

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤

### æœåŠ¡ç®¡ç†

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/uma-audit5

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml stop

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹æŸä¸ªæœåŠ¡çš„æ—¥å¿— (å¦‚åç«¯)
docker-compose -f docker-compose.prod.yml logs -f backend

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
docker-compose -f docker-compose.prod.yml down
```

### å•ä¸ªæœåŠ¡ç®¡ç†

```bash
# é‡å¯åç«¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart backend

# é‡å¯å‰ç«¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart frontend

# é‡å¯æ•°æ®åº“
docker-compose -f docker-compose.prod.yml restart postgres

# é‡å¯Redis
docker-compose -f docker-compose.prod.yml restart redis
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°100è¡Œæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --tail=100

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs | grep -i error

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´çš„æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --since="2025-01-20T10:00:00"
```

---

## ğŸ”§ ç³»ç»Ÿç»´æŠ¤

### å¥åº·æ£€æŸ¥

```bash
# è¿è¡Œå¥åº·æ£€æŸ¥è„šæœ¬
./health-check.sh

# æ‰‹åŠ¨æ£€æŸ¥å„æœåŠ¡
docker ps                           # æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker stats                        # æŸ¥çœ‹èµ„æºä½¿ç”¨
df -h                               # æŸ¥çœ‹ç£ç›˜ç©ºé—´
free -h                             # æŸ¥çœ‹å†…å­˜ä½¿ç”¨
```

### æ•°æ®å¤‡ä»½

```bash
# è¿è¡Œå¤‡ä»½è„šæœ¬
./backup-data.sh

# æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“
docker exec uma_audit_db_prod pg_dump -U postgres uma_audit > backup.sql

# æ‰‹åŠ¨å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
tar -czf uploads_backup.tar.gz ./backend/uploads

# è®¾ç½®æ¯å¤©è‡ªåŠ¨å¤‡ä»½ (å‡Œæ™¨2ç‚¹)
crontab -e
# æ·»åŠ : 0 2 * * * /opt/uma-audit5/backup-data.sh
```

### æ•°æ®æ¢å¤

```bash
# æ¢å¤æ•°æ®åº“
docker exec -i uma_audit_db_prod psql -U postgres uma_audit < backup.sql

# æ¢å¤ä¸Šä¼ æ–‡ä»¶
tar -xzf uploads_backup.tar.gz -C ./backend/
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°ä»£ç 

```bash
cd /opt/uma-audit5

# æ–¹å¼ä¸€: Gitæ‹‰å– (å¦‚æœä½¿ç”¨Git)
git pull

# æ–¹å¼äºŒ: æ‰‹åŠ¨ä¸Šä¼ æ–°ä»£ç  (ä½¿ç”¨WinSCP/FileZilla)

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# è¿è¡Œæ•°æ®åº“è¿ç§»
docker exec -it uma_audit_backend_prod python -m alembic upgrade head
```

### æ›´æ–°é…ç½®

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
vim .env.production

# é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
docker-compose -f docker-compose.prod.yml restart
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### 1. ç½‘ç«™æ‰“ä¸å¼€

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
docker-compose -f docker-compose.prod.yml ps

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tuln | grep 80
netstat -tuln | grep 8000

# æ£€æŸ¥é˜²ç«å¢™
ufw status

# æ£€æŸ¥å®‰å…¨ç»„ (åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°)
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker logs uma_audit_db_prod

# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker exec -it uma_audit_db_prod psql -U postgres

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker exec uma_audit_db_prod pg_isready -U postgres
```

### 3. åç«¯APIé”™è¯¯

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
docker logs uma_audit_backend_prod --tail 100

# è¿›å…¥åç«¯å®¹å™¨
docker exec -it uma_audit_backend_prod bash

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—æ–‡ä»¶
docker exec uma_audit_backend_prod cat logs/error.log
```

### 4. å‰ç«¯é¡µé¢ç©ºç™½

```bash
# æŸ¥çœ‹å‰ç«¯æ—¥å¿—
docker logs uma_audit_frontend_prod

# æ£€æŸ¥Nginxé…ç½®
docker exec uma_audit_frontend_prod nginx -t

# é‡å¯å‰ç«¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart frontend
```

### 5. å†…å­˜ä¸è¶³

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹å®¹å™¨å†…å­˜ä½¿ç”¨
docker stats

# æ¸…ç†Dockerå ç”¨ç©ºé—´
docker system prune -a

# é‡å¯æœåŠ¡é‡Šæ”¾å†…å­˜
docker-compose -f docker-compose.prod.yml restart
```

### 6. ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å¤§æ–‡ä»¶
du -sh /opt/uma-audit5/* | sort -rh | head -10

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
find ./backend/logs -name "*.log" -mtime +7 -delete

# æ¸…ç†æ—§å¤‡ä»½
find /opt/backups -mtime +30 -delete

# æ¸…ç†Docker
docker system prune -a --volumes
```

---

## ğŸ” å®‰å…¨ç›¸å…³

### ä¿®æ”¹å¯†ç 

```bash
# ä¿®æ”¹æ•°æ®åº“å¯†ç 
docker exec -it uma_audit_db_prod psql -U postgres
ALTER USER postgres PASSWORD 'new_password';

# ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
vim .env.production
# ä¿®æ”¹ DATABASE_URL ä¸­çš„å¯†ç 

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart
```

### æŸ¥çœ‹è®¿é—®æ—¥å¿—

```bash
# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
docker exec uma_audit_frontend_prod cat /var/log/nginx/access.log

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
docker exec uma_audit_frontend_prod cat /var/log/nginx/error.log

# æŸ¥çœ‹åç«¯è®¿é—®æ—¥å¿—
docker exec uma_audit_backend_prod cat logs/access.log
```

---

## ğŸ“Š ç›‘æ§å‘½ä»¤

### å®æ—¶ç›‘æ§

```bash
# ç›‘æ§å®¹å™¨èµ„æº
docker stats

# ç›‘æ§ç³»ç»Ÿèµ„æº
htop  # éœ€è¦å®‰è£…: apt install htop

# ç›‘æ§ç£ç›˜IO
iotop  # éœ€è¦å®‰è£…: apt install iotop

# ç›‘æ§ç½‘ç»œæµé‡
iftop  # éœ€è¦å®‰è£…: apt install iftop
```

### æ€§èƒ½åˆ†æ

```bash
# æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ•°
docker exec uma_audit_db_prod psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# æŸ¥çœ‹Redisè¿æ¥æ•°
docker exec uma_audit_redis_prod redis-cli INFO clients

# æŸ¥çœ‹APIå“åº”æ—¶é—´ (æŸ¥çœ‹æ—¥å¿—)
docker-compose -f docker-compose.prod.yml logs backend | grep "ms"
```

---

## ğŸŒ åŸŸåå’ŒHTTPS

### é…ç½®åŸŸå

```bash
# 1. åœ¨åŸŸåæœåŠ¡å•†æ·»åŠ Aè®°å½•
# è®°å½•ç±»å‹: A
# ä¸»æœºè®°å½•: @
# è®°å½•å€¼: æœåŠ¡å™¨IP

# 2. ç­‰å¾…DNSç”Ÿæ•ˆ (5-10åˆ†é’Ÿ)
ping your-domain.com
```

### é…ç½®SSLè¯ä¹¦ (Let's Encrypt)

```bash
# å®‰è£…Certbot
apt install certbot python3-certbot-nginx -y

# åœæ­¢nginxå®¹å™¨
docker stop uma_audit_frontend_prod

# ç”³è¯·è¯ä¹¦
certbot certonly --standalone \
  -d your-domain.com \
  -d www.your-domain.com \
  --email your@email.com \
  --agree-tos

# è¯ä¹¦è·¯å¾„
/etc/letsencrypt/live/your-domain.com/fullchain.pem
/etc/letsencrypt/live/your-domain.com/privkey.pem

# å¤åˆ¶è¯ä¹¦
mkdir -p nginx/ssl
cp /etc/letsencrypt/live/your-domain.com/fullchain.pem nginx/ssl/
cp /etc/letsencrypt/live/your-domain.com/privkey.pem nginx/ssl/

# æ›´æ–°Nginxé…ç½® (å‚è€ƒéƒ¨ç½²æŒ‡å—)
# é‡å¯å‰ç«¯æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build frontend
```

### è‡ªåŠ¨ç»­æœŸè¯ä¹¦

```bash
# æµ‹è¯•ç»­æœŸ
certbot renew --dry-run

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ (æ¯æœˆ1å·å‡Œæ™¨3ç‚¹)
crontab -e
# æ·»åŠ : 0 3 1 * * certbot renew --quiet && docker-compose -f /opt/uma-audit5/docker-compose.prod.yml restart frontend
```

---

## ğŸ“ ç´§æ€¥æƒ…å†µå¤„ç†

### ç³»ç»Ÿå®Œå…¨æ— å“åº”

```bash
# 1. é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# 2. å¦‚æœä»æ— å“åº”,å®Œå…¨é‡å¯
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# 3. å¦‚æœä»æœ‰é—®é¢˜,é‡å¯æœåŠ¡å™¨
reboot
```

### æ•°æ®åº“æŸå

```bash
# 1. åœæ­¢åç«¯æœåŠ¡
docker-compose -f docker-compose.prod.yml stop backend

# 2. ä»å¤‡ä»½æ¢å¤
docker exec -i uma_audit_db_prod psql -U postgres uma_audit < /opt/backups/uma-audit/database_YYYYMMDD_HHMMSS.sql

# 3. é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml start backend
```

### ç£ç›˜å·²æ»¡

```bash
# 1. ç´§æ€¥æ¸…ç†
docker system prune -a --volumes
rm -rf /opt/uma-audit5/backend/logs/*
find /opt/backups -mtime +7 -delete

# 2. æ‰©å®¹ç£ç›˜ (åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°)
```

---

## ğŸ“± è®¿é—®åœ°å€

### é»˜è®¤è®¿é—®

- å‰ç«¯: `http://æœåŠ¡å™¨IP`
- åç«¯APIæ–‡æ¡£: `http://æœåŠ¡å™¨IP:8000/docs`
- åç«¯ç®¡ç†åå°: `http://æœåŠ¡å™¨IP:8000/admin` (å¦‚æœæœ‰)

### åŸŸåè®¿é—® (é…ç½®å)

- å‰ç«¯: `https://your-domain.com`
- åç«¯API: `https://your-domain.com/api`

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- å®Œæ•´éƒ¨ç½²æŒ‡å—: `é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—.md`
- é¡¹ç›®å¼€å‘æ–‡æ¡£: `CLAUDE.md`
- APIæ–‡æ¡£: `http://æœåŠ¡å™¨IP:8000/docs`

---

## ğŸ†˜ è·å–å¸®åŠ©

### æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯

```bash
# ç³»ç»Ÿç‰ˆæœ¬
cat /etc/os-release

# Dockerç‰ˆæœ¬
docker --version
docker-compose --version

# é¡¹ç›®ç‰ˆæœ¬
cat /opt/uma-audit5/VERSION  # å¦‚æœæœ‰

# æœåŠ¡å™¨ä¿¡æ¯
uname -a
```

### å¯¼å‡ºè¯Šæ–­ä¿¡æ¯

```bash
# åˆ›å»ºè¯Šæ–­æŠ¥å‘Š
cat > /tmp/diagnostic_report.txt << EOF
=== ç³»ç»Ÿä¿¡æ¯ ===
$(uname -a)
$(cat /etc/os-release)

=== Dockerä¿¡æ¯ ===
$(docker --version)
$(docker-compose --version)

=== å®¹å™¨çŠ¶æ€ ===
$(docker ps -a)

=== èµ„æºä½¿ç”¨ ===
$(free -h)
$(df -h)

=== æœåŠ¡æ—¥å¿— (æœ€è¿‘50è¡Œ) ===
$(docker-compose -f /opt/uma-audit5/docker-compose.prod.yml logs --tail=50)
EOF

# æŸ¥çœ‹æŠ¥å‘Š
cat /tmp/diagnostic_report.txt
```

---

**æç¤º**:
- æ‰€æœ‰å‘½ä»¤éƒ½éœ€è¦åœ¨é¡¹ç›®ç›®å½• `/opt/uma-audit5` ä¸‹æ‰§è¡Œ
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `docker-compose.prod.yml` æ–‡ä»¶
- é‡è¦æ“ä½œå‰è®°å¾—å…ˆå¤‡ä»½æ•°æ®
- ä¸ç¡®å®šçš„æ“ä½œè¯·å…ˆæŸ¥çœ‹è¯¦ç»†æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
