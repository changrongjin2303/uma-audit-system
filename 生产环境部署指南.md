# 造价材料审计系统 - 生产环境部署指南

## 📋 目录

1. [部署前准备](#部署前准备)
2. [环境要求](#环境要求)
3. [配置文件设置](#配置文件设置)
4. [Docker部署](#docker部署)
5. [手动部署](#手动部署)
6. [SSL证书配置](#ssl证书配置)
7. [监控和日志](#监控和日志)
8. [备份策略](#备份策略)
9. [故障排除](#故障排除)
10. [维护操作](#维护操作)

---

## 🚀 部署前准备

### 1. 服务器要求

**最低配置:**
- CPU: 4核心
- 内存: 8GB RAM
- 存储: 100GB SSD
- 网络: 10Mbps带宽

**推荐配置:**
- CPU: 8核心
- 内存: 16GB RAM
- 存储: 200GB SSD
- 网络: 100Mbps带宽

### 2. 操作系统要求

- Ubuntu 20.04 LTS 或 22.04 LTS
- CentOS 8 或 Rocky Linux 8+
- Docker 20.10+
- Docker Compose 2.0+

### 3. 域名和SSL

- 准备域名（如：audit.company.com）
- SSL证书（推荐Let's Encrypt免费证书）
- DNS解析配置

---

## 🔧 环境要求

### 系统依赖安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y curl wget git vim
sudo apt install -y docker.io docker-compose
sudo systemctl enable docker
sudo systemctl start docker
sudo usermod -aG docker $USER

# CentOS/Rocky Linux
sudo yum update -y
sudo yum install -y curl wget git vim
sudo yum install -y docker docker-compose
sudo systemctl enable docker
sudo systemctl start docker
sudo usermod -aG docker $USER
```

### 防火墙配置

```bash
# Ubuntu (ufw)
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## ⚙️ 配置文件设置

### 1. 环境变量配置

复制生产环境配置模板：

```bash
cp .env.production .env
```

编辑 `.env` 文件：

```bash
# 数据库配置（请修改为生产数据库地址）
DATABASE_URL=postgresql://uma_audit_user:STRONG_DB_PASSWORD@localhost:5432/uma_audit_prod
DB_ECHO=false
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=40

# Redis配置
REDIS_URL=redis://localhost:6379/0
REDIS_PASSWORD=STRONG_REDIS_PASSWORD

# JWT安全配置 - 必须更换为生产密钥！
SECRET_KEY=YOUR_PRODUCTION_JWT_SECRET_KEY_AT_LEAST_64_CHARS_LONG
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 系统配置
DEBUG=false
LOG_LEVEL=WARNING
CORS_ORIGINS=["https://audit.your-domain.com","https://www.audit.your-domain.com"]
ALLOWED_HOSTS=["audit.your-domain.com","www.audit.your-domain.com"]

# 安全限制
API_RATE_LIMIT=200
API_BURST_LIMIT=50
MAX_CONCURRENT_REQUESTS=100

# AI服务配置（请填入真实的API密钥）
OPENAI_API_KEY=sk-your-openai-api-key
DASHSCOPE_API_KEY=sk-your-dashscope-key
BAIDU_API_KEY=your-baidu-api-key
BAIDU_SECRET_KEY=your-baidu-secret-key

# 数据安全
DATA_ENCRYPTION_KEY=your-64-char-encryption-key
BACKUP_ENCRYPTION=true
AUDIT_LOG_RETENTION_DAYS=1095  # 3年

# 监控配置
ENABLE_METRICS=true
METRICS_PORT=9090
```

### 2. 生成安全密钥

```bash
# 生成JWT密钥
python3 -c "import secrets; print('JWT_SECRET_KEY=' + secrets.token_urlsafe(64))"

# 生成数据加密密钥
python3 -c "import secrets; print('DATA_ENCRYPTION_KEY=' + secrets.token_urlsafe(64))"

# 生成强密码
python3 -c "import secrets, string; print(''.join(secrets.choice(string.ascii_letters + string.digits + '!@#$%^&*') for i in range(32)))"
```

---

## 🐳 Docker部署（推荐）

### 1. 生产环境Docker Compose

创建 `docker-compose.prod.yml`：

```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:14-alpine
    container_name: uma_audit_db_prod
    environment:
      POSTGRES_DB: uma_audit_prod
      POSTGRES_USER: uma_audit_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backup:/backup
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uma_audit_user -d uma_audit_prod"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: uma_audit_redis_prod
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 后端API服务
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: uma_audit_backend_prod
    environment:
      - DATABASE_URL=postgresql://uma_audit_user:${DB_PASSWORD}@postgres:5432/uma_audit_prod
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=false
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/logs:/app/logs
      - ./backup:/app/backup
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 前端Web服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: uma_audit_frontend_prod
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - backend
    restart: unless-stopped

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: uma_audit_nginx_prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  nginx_logs:
```

### 2. 生产环境Nginx配置

创建 `nginx/nginx.prod.conf`：

```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 安全头配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name audit.your-domain.com www.audit.your-domain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS主配置
    server {
        listen 443 ssl http2;
        server_name audit.your-domain.com www.audit.your-domain.com;

        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 前端静态文件
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 后端API
        location /api/ {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # API特定设置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 300s;
            proxy_buffering off;
            client_max_body_size 100M;
        }

        # 文件上传
        location /uploads/ {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 100M;
        }
    }
}
```

### 3. 启动生产环境

```bash
# 1. 设置环境变量
export DB_PASSWORD="your-strong-db-password"
export REDIS_PASSWORD="your-strong-redis-password"
export SECRET_KEY="your-jwt-secret-key"

# 2. 创建必要目录
mkdir -p ssl backup nginx logs

# 3. 启动服务
docker-compose -f docker-compose.prod.yml up -d

# 4. 检查服务状态
docker-compose -f docker-compose.prod.yml ps

# 5. 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

---

## 🔒 SSL证书配置

### 使用Let's Encrypt免费证书

```bash
# 1. 安装Certbot
sudo apt install -y certbot

# 2. 停止Nginx（如果正在运行）
sudo systemctl stop nginx

# 3. 获取SSL证书
sudo certbot certonly --standalone \
  -d audit.your-domain.com \
  -d www.audit.your-domain.com \
  --email your-email@domain.com \
  --agree-tos \
  --non-interactive

# 4. 复制证书到项目目录
sudo cp /etc/letsencrypt/live/audit.your-domain.com/fullchain.pem ./ssl/cert.pem
sudo cp /etc/letsencrypt/live/audit.your-domain.com/privkey.pem ./ssl/key.pem
sudo chown $USER:$USER ./ssl/*.pem

# 5. 设置证书自动续期
echo "0 2 * * * root certbot renew --quiet && docker-compose -f /path/to/docker-compose.prod.yml restart nginx" | sudo tee -a /etc/crontab
```

---

## 📊 监控和日志

### 1. 设置系统监控

```bash
# 安装监控依赖
pip3 install psutil asyncpg aiohttp

# 设置监控定时任务
./scripts/setup_cron.sh
```

### 2. 日志配置

生产环境日志目录结构：
```
logs/
├── app.log              # 应用主日志
├── error.log            # 错误日志
├── audit.log            # 审计日志
├── nginx/
│   ├── access.log       # Nginx访问日志
│   └── error.log        # Nginx错误日志
└── cron/
    ├── backup.log       # 备份日志
    ├── monitor.log      # 监控日志
    └── cleanup.log      # 清理日志
```

### 3. 监控告警

配置监控告警脚本：

```bash
# 创建告警脚本
cat > scripts/alert_webhook.py << 'EOF'
#!/usr/bin/env python3
import requests
import sys
import json

def send_alert(message, level="warning"):
    webhook_url = "YOUR_WEBHOOK_URL"  # 钉钉、企业微信等
    
    data = {
        "msgtype": "text",
        "text": {
            "content": f"【造价审计系统告警】\n级别: {level.upper()}\n内容: {message}\n时间: $(date)"
        }
    }
    
    try:
        response = requests.post(webhook_url, json=data)
        response.raise_for_status()
        print("告警发送成功")
    except Exception as e:
        print(f"告警发送失败: {e}")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        send_alert(sys.argv[1], sys.argv[2] if len(sys.argv) > 2 else "warning")
EOF

chmod +x scripts/alert_webhook.py
```

---

## 💾 备份策略

### 1. 自动备份设置

```bash
# 创建备份目录
mkdir -p backup/{database,files,config}

# 设置数据库备份
python3 scripts/backup_database.py create --name "manual_backup_$(date +%Y%m%d)"

# 备份配置文件
cp .env backup/config/env_$(date +%Y%m%d_%H%M%S)
cp docker-compose.prod.yml backup/config/
cp -r nginx backup/config/
```

### 2. 备份验证

```bash
# 验证备份完整性
python3 scripts/backup_database.py list
python3 scripts/backup_database.py stats
```

### 3. 异地备份

```bash
# 使用rsync同步到远程服务器
rsync -avz --delete backup/ user@backup-server:/path/to/remote/backup/

# 使用云存储（如阿里云OSS）
# 安装ossutil64工具后
ossutil64 cp -r backup/ oss://your-bucket/uma-audit-backup/
```

---

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 服务启动失败

```bash
# 检查容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看详细日志
docker-compose -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.prod.yml logs postgres

# 检查端口占用
ss -tulpn | grep :5432
ss -tulpn | grep :6379
```

#### 2. 数据库连接失败

```bash
# 检查数据库状态
docker exec -it uma_audit_db_prod psql -U uma_audit_user -d uma_audit_prod -c "SELECT version();"

# 检查数据库连接配置
grep DATABASE_URL .env
```

#### 3. 前端无法访问

```bash
# 检查Nginx配置
docker exec -it uma_audit_nginx_prod nginx -t

# 重新加载Nginx配置
docker exec -it uma_audit_nginx_prod nginx -s reload

# 检查SSL证书
openssl x509 -in ssl/cert.pem -text -noout
```

#### 4. API性能问题

```bash
# 查看API响应时间
curl -w "@curl-format.txt" -o /dev/null -s "https://audit.your-domain.com/api/v1/health"

# 创建curl-format.txt
cat > curl-format.txt << 'EOF'
     time_namelookup:  %{time_namelookup}s\n
        time_connect:  %{time_connect}s\n
     time_appconnect:  %{time_appconnect}s\n
    time_pretransfer:  %{time_pretransfer}s\n
       time_redirect:  %{time_redirect}s\n
  time_starttransfer:  %{time_starttransfer}s\n
                     ----------\n
          time_total:  %{time_total}s\n
EOF

# 检查数据库性能
docker exec -it uma_audit_db_prod psql -U uma_audit_user -d uma_audit_prod -c "
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;"
```

---

## 🔄 维护操作

### 1. 系统更新

```bash
# 1. 备份当前系统
python3 scripts/backup_database.py create --name "pre_update_backup"

# 2. 拉取最新代码
git pull origin main

# 3. 重新构建镜像
docker-compose -f docker-compose.prod.yml build --no-cache

# 4. 滚动更新
docker-compose -f docker-compose.prod.yml up -d --force-recreate

# 5. 验证更新结果
curl -s https://audit.your-domain.com/health | jq .
```

### 2. 数据库迁移

```bash
# 1. 进入后端容器
docker exec -it uma_audit_backend_prod bash

# 2. 运行数据库迁移
alembic upgrade head

# 3. 验证迁移结果
python -c "
from app.core.database import engine
print('Database migration completed successfully')
"
```

### 3. 清理维护

```bash
# 清理Docker资源
docker system prune -f

# 清理日志文件
find logs/ -name "*.log" -mtime +30 -delete

# 清理过期备份
python3 scripts/backup_database.py cleanup --keep-days 30 --keep-count 10

# 清理上传文件（可选）
find backend/uploads/ -mtime +90 -type f -delete
```

### 4. 性能优化

```bash
# 数据库优化
docker exec -it uma_audit_db_prod psql -U uma_audit_user -d uma_audit_prod -c "
VACUUM ANALYZE;
REINDEX DATABASE uma_audit_prod;
"

# Redis内存优化
docker exec -it uma_audit_redis_prod redis-cli FLUSHDB

# 应用缓存清理
docker exec -it uma_audit_backend_prod python -c "
import redis
r = redis.from_url('redis://:password@redis:6379/0')
r.flushdb()
"
```

---

## 📞 技术支持

### 联系方式
- 技术支持邮箱: support@your-company.com
- 应急联系人: +86-xxx-xxxx-xxxx
- 文档地址: https://docs.your-company.com

### 支持范围
- 系统部署和配置
- 故障排除和修复
- 性能优化建议
- 安全配置指导

---

**注意:** 本指南适用于生产环境部署，请在部署前仔细阅读并根据实际环境调整配置。建议先在测试环境进行完整测试后再部署到生产环境。